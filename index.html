<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>åŒ…å­åª½é–‹åœ˜ç³»çµ±</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Noto Sans TC', sans-serif;
      background: linear-gradient(135deg, #fff5f5 0%, #fce4ec 50%, #f8bbd9 100%);
      min-height: 100vh;
      color: #4a4a4a;
    }
    
    .container {
      max-width: 540px;
      margin: 0 auto;
      padding: 20px;
      padding-bottom: 100px;
    }
    
    .card {
      background: rgba(255,255,255,0.85);
      border-radius: 20px;
      padding: 24px;
      border: 1px solid rgba(236,64,122,0.15);
      margin-bottom: 20px;
      box-shadow: 0 8px 32px rgba(236,64,122,0.1);
    }
    
    h1 {
      font-size: 24px;
      font-weight: 700;
      text-align: center;
      margin-bottom: 8px;
    }
    
    .subtitle {
      color: #b0838a;
      text-align: center;
      font-size: 14px;
      margin-bottom: 28px;
    }
    
    label {
      display: block;
      color: #9c6b74;
      font-size: 14px;
      margin-bottom: 8px;
    }
    
    input, select, textarea {
      width: 100%;
      padding: 14px 16px;
      border-radius: 12px;
      border: 1px solid rgba(236,64,122,0.2);
      background: rgba(255,255,255,0.9);
      color: #4a4a4a;
      font-size: 16px;
      font-family: inherit;
      outline: none;
      transition: border-color 0.2s;
    }
    
    input:focus, select:focus, textarea:focus {
      border-color: #ec407a;
    }
    
    input::placeholder, textarea::placeholder {
      color: #c9a0a7;
    }
    
    select {
      cursor: pointer;
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%23ec407a' viewBox='0 0 16 16'%3E%3Cpath d='M8 11L3 6h10l-5 5z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 16px center;
    }
    
    select option {
      background: #fff;
      color: #4a4a4a;
    }
    
    .btn {
      width: 100%;
      padding: 16px;
      border-radius: 14px;
      border: none;
      font-size: 17px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      font-family: inherit;
    }
    
    .btn-primary {
      background: linear-gradient(135deg, #f48fb1 0%, #ec407a 100%);
      color: #fff;
      box-shadow: 0 8px 32px rgba(236,64,122,0.35);
    }
    
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 40px rgba(236,64,122,0.45);
    }
    
    .btn-primary:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }
    
    .btn-outline {
      background: transparent;
      border: 2px dashed rgba(236,64,122,0.3);
      color: #ec407a;
    }
    
    .btn-outline:hover {
      border-color: rgba(236,64,122,0.5);
      background: rgba(236,64,122,0.05);
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    /* å“é …å¡ç‰‡ */
    .item-card {
      background: rgba(255,255,255,0.7);
      border-radius: 16px;
      padding: 16px;
      margin-bottom: 12px;
      border: 1px solid rgba(236,64,122,0.1);
    }
    
    .item-card.sold-out {
      background: rgba(255,200,200,0.3);
      border-color: rgba(255,100,100,0.3);
    }
    
    .item-header {
      display: flex;
      gap: 14px;
      margin-bottom: 12px;
    }
    
    .item-image {
      width: 72px;
      height: 72px;
      border-radius: 12px;
      object-fit: cover;
      background: rgba(255,255,255,0.1);
      flex-shrink: 0;
    }
    
    .item-image-placeholder {
      width: 72px;
      height: 72px;
      border-radius: 12px;
      background: rgba(236,64,122,0.08);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 28px;
      flex-shrink: 0;
    }
    
    .item-info {
      flex: 1;
      min-width: 0;
    }
    
    .item-name {
      font-size: 17px;
      font-weight: 600;
      margin-bottom: 4px;
      color: #4a4a4a;
    }
    
    .item-desc {
      font-size: 13px;
      color: #9c6b74;
      line-height: 1.4;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
    
    .item-stock {
      font-size: 13px;
      margin-top: 6px;
    }
    
    .item-stock.available {
      color: #ec407a;
    }
    
    .item-stock.sold-out {
      color: #ff6b6b;
    }
    
    .item-controls {
      display: flex;
      align-items: center;
      justify-content: flex-end;
      gap: 14px;
    }
    
    .qty-btn {
      width: 38px;
      height: 38px;
      border-radius: 10px;
      border: none;
      background: rgba(236,64,122,0.1);
      color: #ec407a;
      font-size: 20px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .qty-btn:hover {
      background: rgba(236,64,122,0.2);
    }
    
    .qty-btn.plus {
      background: linear-gradient(135deg, #f48fb1 0%, #ec407a 100%);
      color: #fff;
    }
    
    .qty-btn:disabled {
      opacity: 0.3;
      cursor: not-allowed;
    }
    
    .qty-display {
      font-size: 20px;
      font-weight: 600;
      min-width: 28px;
      text-align: center;
    }
    
    /* ç®¡ç†å“¡å“é …ç·¨è¼¯ */
    .admin-item {
      background: rgba(255,255,255,0.03);
      border-radius: 16px;
      padding: 16px;
      margin-bottom: 12px;
      border: 1px solid rgba(255,255,255,0.08);
    }
    
    .admin-item-row {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
      align-items: center;
    }
    
    .admin-item-row:last-child {
      margin-bottom: 0;
    }
    
    .admin-item input[type="text"],
    .admin-item input[type="number"],
    .admin-item textarea {
      font-size: 14px;
      padding: 12px 14px;
    }
    
    .admin-item input[type="number"] {
      width: 80px;
      text-align: center;
    }
    
    .admin-item textarea {
      resize: none;
      height: 60px;
    }
    
    .remove-btn {
      width: 40px;
      height: 40px;
      border-radius: 10px;
      border: none;
      background: rgba(255,100,100,0.15);
      color: #ff6b6b;
      font-size: 20px;
      cursor: pointer;
      flex-shrink: 0;
    }
    
    /* åœ–ç‰‡ä¸Šå‚³å€ */
    .image-upload-area {
      display: flex;
      gap: 10px;
      align-items: center;
    }
    
    .image-preview {
      width: 60px;
      height: 60px;
      border-radius: 10px;
      object-fit: cover;
      background: rgba(255,255,255,0.1);
      flex-shrink: 0;
    }
    
    .image-preview-placeholder {
      width: 60px;
      height: 60px;
      border-radius: 10px;
      background: rgba(255,255,255,0.05);
      border: 2px dashed rgba(255,255,255,0.2);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      flex-shrink: 0;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .image-preview-placeholder:hover {
      border-color: rgba(255,255,255,0.4);
      background: rgba(255,255,255,0.08);
    }
    
    .image-input-wrapper {
      flex: 1;
      display: flex;
      gap: 8px;
    }
    
    .upload-btn {
      padding: 12px 16px;
      border-radius: 10px;
      border: none;
      background: rgba(102, 126, 234, 0.2);
      color: #a5b4fc;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      white-space: nowrap;
      transition: all 0.2s;
    }
    
    .upload-btn:hover {
      background: rgba(102, 126, 234, 0.3);
    }
    
    .upload-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .upload-btn.uploading {
      background: rgba(255, 193, 7, 0.2);
      color: #ffc107;
    }
    
    /* éš±è—çš„ file input */
    .hidden-file-input {
      display: none;
    }
    
    /* é€²åº¦æ¢ */
    .progress-bar {
      height: 6px;
      background: rgba(255,255,255,0.1);
      border-radius: 3px;
      overflow: hidden;
      margin-top: 8px;
    }
    
    .progress-fill {
      height: 100%;
      border-radius: 3px;
      transition: width 0.3s;
    }
    
    .progress-fill.normal {
      background: linear-gradient(90deg, #4ade80, #22d3ee);
    }
    
    .progress-fill.full {
      background: #ff6b6b;
    }
    
    /* çµ±è¨ˆå¡ç‰‡ */
    .stat-card {
      background: rgba(102, 126, 234, 0.1);
      border-radius: 16px;
      padding: 20px;
      text-align: center;
    }
    
    .stat-label {
      color: rgba(255,255,255,0.5);
      font-size: 14px;
      margin-bottom: 4px;
    }
    
    .stat-value {
      font-size: 42px;
      font-weight: 700;
    }
    
    /* è¨‚å–®åˆ—è¡¨ */
    .order-group {
      background: rgba(255,255,255,0.03);
      border-radius: 14px;
      padding: 16px;
      margin-bottom: 12px;
    }
    
    .order-group-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    
    .order-group-title {
      font-weight: 600;
    }
    
    .order-group-badge {
      background: rgba(102, 126, 234, 0.2);
      color: #a5b4fc;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 13px;
    }
    
    .order-row {
      display: flex;
      justify-content: space-between;
      padding: 10px 0;
      border-top: 1px solid rgba(255,255,255,0.05);
      font-size: 14px;
    }
    
    .order-row:first-of-type {
      border-top: none;
    }
    
    .order-phone {
      color: rgba(255,255,255,0.5);
    }
    
    .order-items {
      color: rgba(255,255,255,0.9);
    }
    
    /* --- åº•éƒ¨å°èˆª (æ›´æ–°ç‚ºç²‰è‰²ç³») --- */
    .bottom-nav {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(236, 64, 122, 0.95); /* æ·±ç²‰è‰²èƒŒæ™¯ */
      border-radius: 50px;
      padding: 6px;
      display: flex;
      gap: 4px;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,0.2);
      z-index: 100;
      box-shadow: 0 4px 20px rgba(236, 64, 122, 0.4);
    }
    
    .nav-btn {
      padding: 12px 22px;
      border-radius: 50px;
      border: none;
      background: transparent;
      color: rgba(255,255,255,0.7); /* æ·ºè‰²æ–‡å­— */
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      font-family: inherit;
    }
    
    .nav-btn.active {
      background: #fff; /* é¸ä¸­æ™‚è®Šç™½è‰² */
      color: #ec407a;    /* é¸ä¸­æ™‚æ–‡å­—è®Šç²‰è‰² */
      font-weight: 700;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    /* --- åº—å®¶ Header æ¨£å¼ --- */
    .brand-header {
      text-align: center;
      margin-bottom: 24px;
      position: relative;
    }
    
    .brand-logo {
      width: 70px;
      height: 70px;
      background: #fff;
      border-radius: 50%;
      margin: 0 auto 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 32px;
      border: 3px solid #f8bbd9;
      box-shadow: 0 4px 15px rgba(236,64,122,0.15);
    }
    
    .brand-name {
      font-size: 20px;
      font-weight: 700;
      color: #d81b60;
      margin-bottom: 4px;
      letter-spacing: 1px;
    }
    
    .brand-subtitle {
      font-size: 15px;
      color: #888;
      font-weight: normal;
    }

    /* æˆåŠŸç•«é¢ */
    .success-screen {
      min-height: 80vh;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .success-content {
      text-align: center;
    }
    
    .success-icon {
      font-size: 72px;
      margin-bottom: 20px;
    }
    
    .success-title {
      font-size: 26px;
      font-weight: 700;
      margin-bottom: 12px;
    }
    
    .success-info {
      color: rgba(255,255,255,0.6);
      margin-bottom: 24px;
      line-height: 1.6;
    }
    
    .success-items {
      background: rgba(74, 222, 128, 0.1);
      border-radius: 14px;
      padding: 18px;
      text-align: left;
    }
    
    .success-item {
      color: #4ade80;
      padding: 6px 0;
      font-size: 15px;
    }
    
    /* éŒ¯èª¤è¨Šæ¯ */
    .error-msg {
      background: rgba(255,100,100,0.1);
      border: 1px solid rgba(255,100,100,0.3);
      border-radius: 12px;
      padding: 14px 18px;
      color: #ff6b6b;
      font-size: 14px;
      text-align: center;
      margin-bottom: 16px;
    }
    
    /* è¼‰å…¥ä¸­ */
    .loading {
      text-align: center;
      padding: 60px 20px;
      color: rgba(255,255,255,0.5);
    }
    
    .spinner {
      width: 40px;
      height: 40px;
      border: 3px solid rgba(255,255,255,0.1);
      border-top-color: #667eea;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin: 0 auto 16px;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* ç©ºç‹€æ…‹ */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: rgba(255,255,255,0.4);
    }
    
    .empty-icon {
      font-size: 56px;
      margin-bottom: 16px;
    }
    
    /* è¤‡è£½é€£çµå€å¡Š */
    .link-box {
      background: rgba(74, 222, 128, 0.1);
      border: 1px solid rgba(74, 222, 128, 0.2);
      border-radius: 12px;
      padding: 16px;
      margin-top: 20px;
    }
    
    .link-label {
      color: #4ade80;
      font-size: 13px;
      margin-bottom: 8px;
    }
    
    .link-row {
      display: flex;
      gap: 10px;
    }
    
    .link-input {
      flex: 1;
      background: rgba(0,0,0,0.3);
      border: none;
      color: #fff;
      font-size: 13px;
    }
    
    .copy-btn {
      padding: 12px 20px;
      border-radius: 10px;
      border: none;
      background: #4ade80;
      color: #000;
      font-weight: 600;
      font-size: 14px;
      cursor: pointer;
      white-space: nowrap;
    }

    /* åˆ†åº—æ¨™ç±¤ */
    .store-tag {
      display: inline-block;
      background: rgba(102, 126, 234, 0.15);
      color: #a5b4fc;
      padding: 2px 8px;
      border-radius: 6px;
      font-size: 12px;
      margin-right: 6px;
    }

    /* Toast é€šçŸ¥ */
    .toast {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.9);
      color: #fff;
      padding: 12px 24px;
      border-radius: 12px;
      font-size: 14px;
      z-index: 200;
      animation: fadeInOut 2.5s ease;
    }
    
    @keyframes fadeInOut {
      0% { opacity: 0; transform: translateX(-50%) translateY(-10px); }
      15% { opacity: 1; transform: translateX(-50%) translateY(0); }
      85% { opacity: 1; transform: translateX(-50%) translateY(0); }
      100% { opacity: 0; transform: translateX(-50%) translateY(-10px); }
    }

    /* åœ–ç‰‡ä¸Šå‚³é¸é …å½ˆçª— */
    .upload-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 150;
      padding: 20px;
    }
    
    .upload-modal-content {
      background: #1a1a2e;
      border-radius: 20px;
      padding: 24px;
      width: 100%;
      max-width: 320px;
      border: 1px solid rgba(255,255,255,0.1);
    }
    
    .upload-modal-title {
      font-size: 18px;
      font-weight: 600;
      text-align: center;
      margin-bottom: 20px;
    }
    
    .upload-option {
      display: flex;
      align-items: center;
      gap: 14px;
      padding: 16px;
      background: rgba(255,255,255,0.05);
      border-radius: 12px;
      margin-bottom: 10px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .upload-option:hover {
      background: rgba(255,255,255,0.1);
    }
    
    .upload-option-icon {
      font-size: 28px;
    }
    
    .upload-option-text {
      font-size: 15px;
    }
    
    .upload-modal-cancel {
      width: 100%;
      padding: 14px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.2);
      background: transparent;
      color: rgba(255,255,255,0.6);
      font-size: 15px;
      cursor: pointer;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <div id="app"></div>
  <div id="toast-container"></div>
  <div id="modal-container"></div>

  <input type="file" id="file-input-camera" accept="image/*" capture="environment" class="hidden-file-input">
  <input type="file" id="file-input-gallery" accept="image/*" class="hidden-file-input">

  <script>
    // ====== è¨­å®š ======
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzZ-AcwAJQcfq8npulJ07SDRuKN7_JSjP-C6Dze6PXRYHUeswZbUwefn2HVvYEsFmWFzw/exec';
    
    // Imgur API (ä½¿ç”¨åŒ¿åä¸Šå‚³)
    const IMGUR_CLIENT_ID = 'f9ae284a4535206';
    
    const STORES = [
      'ä¸­å’Œ', 'æ–‡å±±', 'æ°¸å’Œ', 'æ—å£', 'å¹³é®', 'å¤è¯', 'å—å¹³', 'è¬è¯', 'ä¸‰å³½',
      'ç’°çƒ', 'å¿ é †', 'æ³°å±±', 'å››è™Ÿå…¬åœ’', 'æ¿æ©‹', 'æ¹–å£', 'æ·¡æ°´', 'æ¾å±±', 'ç¶“åœ‹'
    ];

    // ====== ç‹€æ…‹ç®¡ç† ======
    let state = {
      view: 'admin',
      adminMode: 'create',
      currentSheet: localStorage.getItem('currentSheet') || '',
      formConfig: null,
      orders: [],
      loading: false,
      error: '',
      formTitle: '',
      items: [{ name: '', limit: 30, image: '', description: '' }],
      selectedStore: '',
      phone: '',
      selectedItems: {},
      successInfo: null,
      uploadingIndex: -1, // æ­£åœ¨ä¸Šå‚³åœ–ç‰‡çš„å“é … index
      showUploadModal: false,
      uploadTargetIndex: -1
    };

    // ====== åœ–ç‰‡ä¸Šå‚³ ======
    async function uploadToImgur(file) {
      const formData = new FormData();
      formData.append('image', file);
      
      try {
        const response = await fetch('https://api.imgur.com/3/image', {
          method: 'POST',
          headers: {
            'Authorization': `Client-ID ${IMGUR_CLIENT_ID}`
          },
          body: formData
        });
        
        const data = await response.json();
        
        if (data.success) {
          return data.data.link;
        } else {
          throw new Error(data.data.error || 'ä¸Šå‚³å¤±æ•—');
        }
      } catch (error) {
        console.error('Imgur upload error:', error);
        throw error;
      }
    }

    function showUploadOptions(index) {
      state.showUploadModal = true;
      state.uploadTargetIndex = index;
      renderModal();
    }

    function hideUploadModal() {
      state.showUploadModal = false;
      state.uploadTargetIndex = -1;
      renderModal();
    }

    function triggerCameraUpload() {
      hideUploadModal();
      document.getElementById('file-input-camera').click();
    }

    function triggerGalleryUpload() {
      hideUploadModal();
      document.getElementById('file-input-gallery').click();
    }

    async function handleFileSelect(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      const index = state.uploadTargetIndex;
      if (index < 0) return;
      
      state.uploadingIndex = index;
      render();
      
      try {
        showToast('ğŸ“¤ ä¸Šå‚³ä¸­...');
        const imageUrl = await uploadToImgur(file);
        state.items[index].image = imageUrl;
        showToast('âœ… ä¸Šå‚³æˆåŠŸï¼');
      } catch (error) {
        showToast('âŒ ä¸Šå‚³å¤±æ•—ï¼Œè«‹é‡è©¦');
        console.error(error);
      }
      
      state.uploadingIndex = -1;
      state.uploadTargetIndex = -1;
      event.target.value = ''; // æ¸…é™¤é¸æ“‡ï¼Œå…è¨±é‡è¤‡é¸åŒä¸€æª”æ¡ˆ
      render();
    }

    // è¨­å®š file input äº‹ä»¶
    document.getElementById('file-input-camera').addEventListener('change', handleFileSelect);
    document.getElementById('file-input-gallery').addEventListener('change', handleFileSelect);

    // ====== Toast é€šçŸ¥ ======
    function showToast(message) {
      const container = document.getElementById('toast-container');
      container.innerHTML = `<div class="toast">${message}</div>`;
      setTimeout(() => {
        container.innerHTML = '';
      }, 2500);
    }

    // ====== Modal æ¸²æŸ“ ======
    function renderModal() {
      const container = document.getElementById('modal-container');
      
      if (state.showUploadModal) {
        container.innerHTML = `
          <div class="upload-modal" onclick="hideUploadModal()">
            <div class="upload-modal-content" onclick="event.stopPropagation()">
              <div class="upload-modal-title">ğŸ“· é¸æ“‡åœ–ç‰‡ä¾†æº</div>
              
              <div class="upload-option" onclick="triggerCameraUpload()">
                <span class="upload-option-icon">ğŸ“¸</span>
                <span class="upload-option-text">æ‹ç…§</span>
              </div>
              
              <div class="upload-option" onclick="triggerGalleryUpload()">
                <span class="upload-option-icon">ğŸ–¼ï¸</span>
                <span class="upload-option-text">å¾ç›¸ç°¿é¸æ“‡</span>
              </div>
              
              <button class="upload-modal-cancel" onclick="hideUploadModal()">å–æ¶ˆ</button>
            </div>
          </div>
        `;
      } else {
        container.innerHTML = '';
      }
    }

    // ====== æ¸²æŸ“å‡½æ•¸ ======
    function render() {
      const app = document.getElementById('app');
      
      let content = '';
      
      if (state.view === 'admin') {
        content = renderAdmin();
      } else if (state.view === 'customer') {
        content = renderCustomer();
      } else if (state.view === 'success') {
        content = renderSuccess();
      }
      
      content += renderBottomNav();
      
      app.innerHTML = content;
      attachEventListeners();
    }

    function renderAdmin() {
      if (state.adminMode === 'create' || !state.currentSheet) {
        return renderCreateForm();
      } else {
        return renderStats();
      }
    }

    function renderCreateForm() {
      let itemsHTML = state.items.map((item, index) => {
        const isUploading = state.uploadingIndex === index;
        
        return `
        <div class="admin-item">
          <div class="admin-item-row">
            <input type="text" placeholder="å“é …åç¨±" value="${item.name}" onchange="updateItem(${index}, 'name', this.value)" style="flex:1">
            <input type="number" placeholder="é™é‡" value="${item.limit}" onchange="updateItem(${index}, 'limit', this.value)">
            <span style="color:rgba(255,255,255,0.4);padding:12px 4px">ä»½</span>
            ${state.items.length > 1 ? `<button class="remove-btn" onclick="removeItem(${index})">Ã—</button>` : ''}
          </div>
          
          <div class="admin-item-row">
            <div class="image-upload-area" style="flex:1">
              ${item.image ? 
                `<img src="${item.image}" class="image-preview" onclick="showUploadOptions(${index})">` :
                `<div class="image-preview-placeholder" onclick="showUploadOptions(${index})">ğŸ“·</div>`
              }
              <div class="image-input-wrapper">
                <input type="text" placeholder="æˆ–è²¼ä¸Šåœ–ç‰‡ç¶²å€" value="${item.image}" onchange="updateItem(${index}, 'image', this.value)" style="flex:1">
                <button class="upload-btn ${isUploading ? 'uploading' : ''}" onclick="showUploadOptions(${index})" ${isUploading ? 'disabled' : ''}>
                  ${isUploading ? 'ä¸Šå‚³ä¸­...' : 'ä¸Šå‚³'}
                </button>
              </div>
            </div>
          </div>
          
          <div class="admin-item-row">
            <textarea placeholder="å•†å“ç°¡ä»‹ï¼ˆé¸å¡«ï¼‰" onchange="updateItem(${index}, 'description', this.value)">${item.description}</textarea>
          </div>
        </div>
      `}).join('');

      return `
        <div class="container">
          <div class="card">
            <h1>ğŸ›’ å¿«é€Ÿé–‹åœ˜</h1>
            <p class="subtitle">è¨­å®šå“é …ï¼Œä¸€éµç”¢ç”Ÿè¡¨å–®</p>
            
            <div class="form-group">
              <label>åœ˜è³¼æ¨™é¡Œ</label>
              <input type="text" placeholder="ä¾‹å¦‚ï¼š2/4 è‰è“è›‹ç³•åœ˜" value="${state.formTitle}" onchange="state.formTitle=this.value">
            </div>
            
            <div class="form-group">
              <label>å“é …è¨­å®š</label>
              ${itemsHTML}
            </div>
            
            <button class="btn btn-outline" onclick="addItem()" style="margin-bottom:20px">
              + æ–°å¢å“é …
            </button>
            
            ${state.error ? `<div class="error-msg">${state.error}</div>` : ''}
            
            <button class="btn btn-primary" onclick="createForm()" ${state.loading ? 'disabled' : ''}>
              ${state.loading ? 'è™•ç†ä¸­...' : 'ğŸš€ ç”¢ç”Ÿè¡¨å–®'}
            </button>
          </div>
        </div>
      `;
    }

    function renderStats() {
      if (state.loading) {
        return `
          <div class="container">
            <div class="loading">
              <div class="spinner"></div>
              <div>è¼‰å…¥ä¸­...</div>
            </div>
          </div>
        `;
      }

      if (!state.formConfig) {
        return `
          <div class="container">
            <div class="empty-state">
              <div class="empty-icon">ğŸ“‹</div>
              <div>æ‰¾ä¸åˆ°è¡¨å–®è³‡æ–™</div>
            </div>
          </div>
        `;
      }

      const ordersByStore = {};
      const ordersByItem = {};
      
      state.orders.forEach(order => {
        if (!ordersByStore[order.store]) ordersByStore[order.store] = [];
        ordersByStore[order.store].push(order);
        
        if (!ordersByItem[order.item]) ordersByItem[order.item] = 0;
        ordersByItem[order.item] += order.quantity;
      });

      const uniquePhones = new Set(state.orders.map(o => o.phone));

      let itemStatsHTML = state.formConfig.items.map(item => {
        const ordered = ordersByItem[item.name] || 0;
        const percentage = Math.min((ordered / item.limit) * 100, 100);
        const isFull = ordered >= item.limit;
        
        return `
          <div style="margin-bottom:16px">
            <div style="display:flex;justify-content:space-between;margin-bottom:6px">
              <span>${item.name}</span>
              <span style="color:${isFull ? '#ff6b6b' : '#4ade80'}">
                ${ordered} / ${item.limit} ${isFull ? '(å·²é¡æ»¿)' : ''}
              </span>
            </div>
            <div class="progress-bar">
              <div class="progress-fill ${isFull ? 'full' : 'normal'}" style="width:${percentage}%"></div>
            </div>
          </div>
        `;
      }).join('');

      let storeOrdersHTML = Object.entries(ordersByStore).map(([store, orders]) => {
        const ordersByPhone = {};
        orders.forEach(order => {
          if (!ordersByPhone[order.phone]) {
            ordersByPhone[order.phone] = { phone: order.phone, items: {} };
          }
          if (!ordersByPhone[order.phone].items[order.item]) {
            ordersByPhone[order.phone].items[order.item] = 0;
          }
          ordersByPhone[order.phone].items[order.item] += order.quantity;
        });

        const orderRows = Object.values(ordersByPhone).map(o => {
          const itemsText = Object.entries(o.items).map(([name, qty]) => `${name}Ã—${qty}`).join(', ');
          return `
            <div class="order-row">
              <span class="order-phone">...${o.phone}</span>
              <span class="order-items">${itemsText}</span>
            </div>
          `;
        }).join('');

        return `
          <div class="order-group">
            <div class="order-group-header">
              <span class="order-group-title">ğŸ“ ${store}</span>
              <span class="order-group-badge">${Object.keys(ordersByPhone).length} äºº</span>
            </div>
            ${orderRows}
          </div>
        `;
      }).join('');

      const customerLink = window.location.href.split('?')[0] + '?sheet=' + encodeURIComponent(state.currentSheet);

      return `
        <div class="container">
          <div class="card">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
              <h1 style="text-align:left;margin:0;font-size:20px">ğŸ“Š ${state.formConfig.title}</h1>
              <button class="btn btn-primary" style="width:auto;padding:10px 20px;font-size:14px" onclick="newForm()">
                + é–‹æ–°åœ˜
              </button>
            </div>
            
            <div style="margin-bottom:24px">
              <label style="margin-bottom:12px">å“é …çµ±è¨ˆ</label>
              ${itemStatsHTML}
            </div>
            
            <div class="stat-card">
              <div class="stat-label">è¨‚è³¼äººæ•¸</div>
              <div class="stat-value">${uniquePhones.size}</div>
            </div>
            
            <div class="link-box">
              <div class="link-label">ğŸ“ å®¢äººå¡«å¯«é€£çµï¼ˆåˆ†äº«åˆ° LINE ç¤¾ç¾¤ï¼‰</div>
              <div class="link-row">
                <input type="text" class="link-input" value="${customerLink}" readonly id="customerLink">
                <button class="copy-btn" onclick="copyLink()">è¤‡è£½</button>
              </div>
            </div>
          </div>
          
          ${storeOrdersHTML ? `
            <div class="card">
              <h2 style="font-size:18px;margin-bottom:16px">ğŸ“‹ è¨‚å–®æ˜ç´°</h2>
              ${storeOrdersHTML}
            </div>
          ` : `
            <div class="empty-state">
              <div class="empty-icon">ğŸ“­</div>
              <div>é‚„æ²’æœ‰è¨‚å–®</div>
            </div>
          `}
        </div>
      `;
    }

    function renderCustomer() {
      if (!state.currentSheet) {
        return `
          <div class="container">
            <div class="empty-state">
              <div class="empty-icon">ğŸ“‹</div>
              <div>å°šæœªé–‹åœ˜</div>
              <div style="margin-top:8px;font-size:14px">è«‹ç­‰å¾…åœ˜ä¸»åˆ†äº«é€£çµ</div>
            </div>
          </div>
        `;
      }

      if (state.loading) {
        return `
          <div class="container">
            <div class="loading">
              <div class="spinner"></div>
              <div>è¼‰å…¥ä¸­...</div>
            </div>
          </div>
        `;
      }

      if (!state.formConfig) {
        return `
          <div class="container">
            <div class="empty-state">
              <div class="empty-icon">âŒ</div>
              <div>æ‰¾ä¸åˆ°æ­¤åœ˜è³¼è¡¨å–®</div>
            </div>
          </div>
        `;
      }

      let storeOptions = STORES.map(s => 
        `<option value="${s}" ${state.selectedStore === s ? 'selected' : ''}>${s}</option>`
      ).join('');

      let itemsHTML = state.formConfig.items.map((item, index) => {
        const remaining = item.remaining !== undefined ? item.remaining : (item.limit - (item.ordered || 0));
        const isSoldOut = remaining <= 0;
        const selectedQty = state.selectedItems[item.name] || 0;

        return `
          <div class="item-card ${isSoldOut ? 'sold-out' : ''}">
            <div class="item-header">
              ${item.image ? 
                `<img src="${item.image}" class="item-image" onerror="this.style.display='none'">` : 
                `<div class="item-image-placeholder">ğŸ›ï¸</div>`
              }
              <div class="item-info">
                <div class="item-name">${item.name}</div>
                ${item.description ? `<div class="item-desc">${item.description}</div>` : ''}
                <div class="item-stock ${isSoldOut ? 'sold-out' : 'available'}">
                  ${isSoldOut ? 'å·²é¡æ»¿' : `å‰©é¤˜ ${remaining} ä»½`}
                </div>
              </div>
            </div>
            ${!isSoldOut ? `
              <div class="item-controls">
                <button class="qty-btn" onclick="changeQty('${item.name}', -1)" ${selectedQty <= 0 ? 'disabled' : ''}>âˆ’</button>
                <span class="qty-display">${selectedQty}</span>
                <button class="qty-btn plus" onclick="changeQty('${item.name}', 1)" ${selectedQty >= remaining ? 'disabled' : ''}>+</button>
              </div>
            ` : ''}
          </div>
        `;
      }).join('');

      return `
        <div class="container">
          <div class="brand-header">
            <div class="brand-logo">ğŸ¥Ÿ</div>
            <div class="brand-name">åŒ…å­åª½ç”Ÿé®®å°èˆ–</div>
            <div class="brand-subtitle">${state.formConfig.title}</div>
          </div>
          <div class="card">
            <p class="subtitle">è«‹å¡«å¯«ä»¥ä¸‹è³‡æ–™å®Œæˆç™»è¨˜</p>
            
            <div class="form-group">
              <label>ğŸ“ å–è²¨åˆ†åº—</label>
              <select onchange="state.selectedStore=this.value;state.error='';render()">
                <option value="">è«‹é¸æ“‡åˆ†åº—</option>
                ${storeOptions}
              </select>
            </div>
            
            <div class="form-group">
              <label>ğŸ“± é›»è©±å¾Œå…­ç¢¼</label>
              <input type="tel" placeholder="ä¾‹å¦‚ï¼š123456" maxlength="6" value="${state.phone}" 
                     oninput="state.phone=this.value.slice(0,6);state.error=''" 
                     style="letter-spacing:4px;text-align:center">
            </div>
            
            <div class="form-group">
              <label>ğŸ›’ é¸æ“‡å“é …</label>
              ${itemsHTML}
            </div>
            
            ${state.error ? `<div class="error-msg">${state.error}</div>` : ''}
            
            <button class="btn btn-primary" onclick="submitOrder()" ${state.loading ? 'disabled' : ''}>
              ${state.loading ? 'é€å‡ºä¸­...' : 'âœ“ ç¢ºèªç™»è¨˜'}
            </button>
          </div>
        </div>
      `;
    }

    function renderSuccess() {
      const info = state.successInfo || {};
      const itemsHTML = Object.entries(info.items || {})
        .filter(([_, qty]) => qty > 0)
        .map(([name, qty]) => `<div class="success-item">${name} Ã— ${qty}</div>`)
        .join('');

      return `
        <div class="container">
          <div class="success-screen">
            <div class="success-content">
              <div class="success-icon">âœ…</div>
              <h2 class="success-title">ç™»è¨˜æˆåŠŸï¼</h2>
              <p class="success-info">
                å–è²¨åˆ†åº—ï¼š${info.store}<br>
                é›»è©±æœ«å…­ç¢¼ï¼š${info.phone}
              </p>
              <div class="success-items">
                ${itemsHTML}
              </div>
              <button class="btn btn-outline" style="margin-top:24px" onclick="resetCustomerForm()">
                ç¹¼çºŒç™»è¨˜å…¶ä»–å“é …
              </button>
            </div>
          </div>
        </div>
      `;
    }

    function renderBottomNav() {
      return `
        <div class="bottom-nav">
          <button class="nav-btn ${state.view === 'admin' ? 'active' : ''}" onclick="switchView('admin')">
            ğŸ‘¤ ç®¡ç†
          </button>
          <button class="nav-btn ${state.view === 'customer' || state.view === 'success' ? 'active' : ''}" onclick="switchView('customer')">
            ğŸ›’ å®¢äºº
          </button>
        </div>
      `;
    }

    // ====== äº‹ä»¶è™•ç† ======
    function attachEventListeners() {}

    function switchView(view) {
      state.view = view;
      state.error = '';
      
      if (view === 'customer' && state.currentSheet) {
        loadFormData();
      } else if (view === 'admin' && state.currentSheet && state.adminMode === 'stats') {
        loadOrders();
      }
      
      render();
    }

    function addItem() {
      state.items.push({ name: '', limit: 30, image: '', description: '' });
      render();
    }

    function removeItem(index) {
      if (state.items.length > 1) {
        state.items.splice(index, 1);
        render();
      }
    }

    function updateItem(index, field, value) {
      state.items[index][field] = field === 'limit' ? (parseInt(value) || 0) : value;
      if (field === 'image') {
        render(); // é‡æ–°æ¸²æŸ“ä»¥é¡¯ç¤ºåœ–ç‰‡é è¦½
      }
    }

    async function createForm() {
      const validItems = state.items.filter(item => item.name.trim());
      
      if (validItems.length === 0) {
        state.error = 'è«‹è‡³å°‘å¡«å¯«ä¸€å€‹å“é …åç¨±';
        render();
        return;
      }
      
      state.loading = true;
      state.error = '';
      render();
      
      const formTitle = state.formTitle || new Date().toLocaleDateString('zh-TW') + ' é–‹åœ˜';
      
      try {
        const response = await fetch(SCRIPT_URL, {
          method: 'POST',
          body: JSON.stringify({
            action: 'createForm',
            formTitle: formTitle,
            items: validItems,
            stores: STORES
          })
        });
        
        const result = await response.json();
        
        if (result.success) {
          state.currentSheet = result.sheetName;
          state.formConfig = result.formConfig;
          state.adminMode = 'stats';
          state.orders = [];
          localStorage.setItem('currentSheet', state.currentSheet);
          showToast('âœ… é–‹åœ˜æˆåŠŸï¼');
        } else {
          state.error = result.error || 'å»ºç«‹å¤±æ•—ï¼Œè«‹é‡è©¦';
        }
      } catch (error) {
        state.currentSheet = formTitle;
        state.formConfig = {
          title: formTitle,
          items: validItems.map(item => ({...item, ordered: 0, remaining: item.limit})),
          stores: STORES
        };
        state.adminMode = 'stats';
        state.orders = [];
        localStorage.setItem('currentSheet', state.currentSheet);
        showToast('âœ… é–‹åœ˜æˆåŠŸï¼');
      }
      
      state.loading = false;
      render();
    }

    function newForm() {
      state.adminMode = 'create';
      state.formTitle = '';
      state.items = [{ name: '', limit: 30, image: '', description: '' }];
      state.error = '';
      render();
    }

    async function loadOrders() {
      state.loading = true;
      render();
      
      try {
        const response = await fetch(`${SCRIPT_URL}?action=getOrders&sheetName=${encodeURIComponent(state.currentSheet)}`);
        const result = await response.json();
        
        if (result.success) {
          state.orders = result.orders || [];
          state.formConfig = result.formConfig;
        }
      } catch (error) {
        console.error('Load orders error:', error);
      }
      
      state.loading = false;
      render();
    }

    function copyLink() {
      const input = document.getElementById('customerLink');
      input.select();
      input.setSelectionRange(0, 99999); // æ‰‹æ©Ÿæ”¯æ´
      document.execCommand('copy');
      
      showToast('âœ… é€£çµå·²è¤‡è£½ï¼');
    }

    async function loadFormData() {
      state.loading = true;
      render();
      
      try {
        const response = await fetch(`${SCRIPT_URL}?action=getFormData&sheetName=${encodeURIComponent(state.currentSheet)}`);
        const result = await response.json();
        
        if (result.success) {
          state.formConfig = result.formConfig;
        } else {
          state.formConfig = null;
        }
      } catch (error) {
        console.error('Load form error:', error);
      }
      
      state.loading = false;
      render();
    }

    function changeQty(itemName, delta) {
      const currentQty = state.selectedItems[itemName] || 0;
      const newQty = Math.max(0, currentQty + delta);
      
      const item = state.formConfig.items.find(i => i.name === itemName);
      if (item) {
        const remaining = item.remaining !== undefined ? item.remaining : (item.limit - (item.ordered || 0));
        if (newQty <= remaining) {
          state.selectedItems[itemName] = newQty;
        }
      }
      
      render();
    }

    async function submitOrder() {
      if (!state.selectedStore) {
        state.error = 'è«‹é¸æ“‡å–è²¨åˆ†åº—';
        render();
        return;
      }
      
      if (!state.phone || state.phone.length !== 6 || !/^\d+$/.test(state.phone)) {
        state.error = 'è«‹è¼¸å…¥æ­£ç¢ºçš„é›»è©±å¾Œå…­ç¢¼';
        render();
        return;
      }
      
      const orderItems = {};
      let hasItem = false;
      
      for (const [name, qty] of Object.entries(state.selectedItems)) {
        if (qty > 0) {
          orderItems[name] = qty;
          hasItem = true;
        }
      }
      
      if (!hasItem) {
        state.error = 'è«‹è‡³å°‘é¸æ“‡ä¸€å€‹å“é …';
        render();
        return;
      }
      
      state.loading = true;
      state.error = '';
      render();
      
      try {
        const response = await fetch(SCRIPT_URL, {
          method: 'POST',
          body: JSON.stringify({
            action: 'submitOrder',
            sheetName: state.currentSheet,
            store: state.selectedStore,
            phone: state.phone,
            items: orderItems
          })
        });
        
        const result = await response.json();
        
        if (result.success) {
          state.successInfo = {
            store: state.selectedStore,
            phone: state.phone,
            items: orderItems
          };
          state.view = 'success';
        } else {
          state.error = result.error || 'é€å‡ºå¤±æ•—ï¼Œè«‹é‡è©¦';
        }
      } catch (error) {
        state.successInfo = {
          store: state.selectedStore,
          phone: state.phone,
          items: orderItems
        };
        state.view = 'success';
      }
      
      state.loading = false;
      render();
    }

    function resetCustomerForm() {
      state.view = 'customer';
      state.selectedStore = '';
      state.phone = '';
      state.selectedItems = {};
      state.error = '';
      loadFormData();
    }

    // ====== åˆå§‹åŒ– ======
    function init() {
      const urlParams = new URLSearchParams(window.location.search);
      const sheetParam = urlParams.get('sheet');
      
      if (sheetParam) {
        state.currentSheet = sheetParam;
        state.view = 'customer';
        localStorage.setItem('currentSheet', sheetParam);
        loadFormData();
      } else if (state.currentSheet) {
        state.adminMode = 'stats';
        loadOrders();
      }
      
      render();
    }

    init();
  </script>
</body>
</html>
