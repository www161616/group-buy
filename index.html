<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>åŒ…å­åª½é–‹åœ˜ç³»çµ±</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    /* === åŸºç¤è¨­å®š === */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Noto Sans TC', sans-serif;
      background: linear-gradient(135deg, #fff5f5 0%, #fce4ec 50%, #f8bbd9 100%);
      min-height: 100vh;
      color: #2c2c2c; 
    }
    .container { max-width: 540px; margin: 0 auto; padding: 20px; padding-bottom: 100px; }
    
    /* === å¡ç‰‡èˆ‡å®¹å™¨ === */
    .card {
      background: rgba(255,255,255,0.9);
      border-radius: 20px;
      padding: 24px;
      border: 1px solid rgba(236,64,122,0.15);
      margin-bottom: 20px;
      box-shadow: 0 8px 32px rgba(236,64,122,0.1);
    }
    
    /* === æ–‡å­—æ’ç‰ˆ === */
    h1 { font-size: 24px; font-weight: 700; text-align: center; margin-bottom: 8px; color: #1a1a1a; }
    .subtitle { color: #884455; text-align: center; font-size: 15px; margin-bottom: 28px; font-weight: 500; }
    label { display: block; color: #442222; font-size: 15px; font-weight: 700; margin-bottom: 8px; }
    
    /* === è¼¸å…¥å…ƒä»¶ === */
    input, select, textarea {
      width: 100%; padding: 14px 16px; border-radius: 12px;
      border: 1px solid rgba(236,64,122,0.3); background: #fff;
      color: #000; font-size: 16px; font-family: inherit; outline: none;
      transition: border-color 0.2s; font-weight: 500;
    }
    input:focus, select:focus, textarea:focus { border-color: #ec407a; background: #fffafa; }
    input::placeholder, textarea::placeholder { color: #997b80; }
    
    select {
      cursor: pointer; appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%23ec407a' viewBox='0 0 16 16'%3E%3Cpath d='M8 11L3 6h10l-5 5z'/%3E%3C/svg%3E");
      background-repeat: no-repeat; background-position: right 16px center;
    }
    select option { background: #fff; color: #000; }
    
    /* === æŒ‰éˆ• === */
    .btn {
      width: 100%; 
      padding: 18px 24px; 
      border-radius: 14px; 
      border: none;
      font-size: 18px; 
      font-weight: 700; 
      cursor: pointer;
      transition: all 0.2s; 
      font-family: inherit;
      display: block; 
      text-align: center;
      margin-top: 12px;
    }
    .btn-primary {
      background: linear-gradient(135deg, #f48fb1 0%, #ec407a 100%);
      color: #fff; 
      box-shadow: 0 8px 32px rgba(236,64,122,0.35);
      text-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }
    .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 12px 40px rgba(236,64,122,0.45); }
    .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
    
    .btn-outline { 
      background: #fff; 
      border: 2px dashed #ec407a; 
      color: #d81b60;
    }
    .btn-outline:hover { border-color: #d81b60; background: rgba(236,64,122,0.05); }
    
    .form-group { margin-bottom: 20px; }
    
    /* === å“é …å¡ç‰‡ === */
    .item-card {
      background: #fff; border-radius: 16px; padding: 16px;
      margin-bottom: 12px; border: 1px solid rgba(236,64,122,0.2);
      box-shadow: 0 2px 8px rgba(0,0,0,0.03);
    }
    .item-card.sold-out { background: #fff0f0; border-color: #ffcccc; }
    .item-card.waitlist { background: #fffbeb; border-color: #fcd34d; }
    
    .item-header { display: flex; gap: 14px; margin-bottom: 12px; }
    .item-image {
      width: 72px; height: 72px; border-radius: 12px; object-fit: cover;
      background: #f5f5f5; flex-shrink: 0; border: 1px solid rgba(0,0,0,0.05);
    }
    .item-image-placeholder {
      width: 72px; height: 72px; border-radius: 12px;
      background: rgba(236,64,122,0.08); display: flex;
      align-items: center; justify-content: center; font-size: 28px; flex-shrink: 0;
    }
    .item-info { flex: 1; min-width: 0; }
    .item-name { font-size: 18px; font-weight: 700; margin-bottom: 4px; color: #222; }
    .item-desc {
      font-size: 14px; color: #555; line-height: 1.4;
      display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical;
      overflow: hidden; margin-bottom: 4px;
    }
    .item-stock { font-size: 13px; margin-top: 6px; font-weight: 500; }
    .item-stock.available { color: #d81b60; }
    .item-stock.sold-out { color: #d32f2f; }
    .item-stock.waitlist { color: #d97706; }
    
    .item-controls { display: flex; align-items: center; justify-content: flex-end; gap: 14px; }
    .qty-btn {
      width: 38px; height: 38px; border-radius: 10px;
      border: 1px solid rgba(236,64,122,0.2); background: #fff;
      color: #d81b60; font-size: 20px; cursor: pointer; transition: all 0.2s;
    }
    .qty-btn:hover { background: #fff0f5; border-color: #ec407a; }
    .qty-btn.plus { background: linear-gradient(135deg, #f48fb1 0%, #ec407a 100%); color: #fff; border: none; }
    .qty-btn:disabled { opacity: 0.3; cursor: not-allowed; border-color: #ddd; color: #999; }
    .qty-display { font-size: 20px; font-weight: 700; min-width: 28px; text-align: center; color: #333; }
    
    /* === ç®¡ç†å“¡ä»‹é¢ === */
    .admin-item {
      background: rgba(255,255,255,0.5); border-radius: 16px;
      padding: 16px; margin-bottom: 12px; border: 1px solid rgba(0,0,0,0.1);
    }
    .admin-item-row { display: flex; gap: 10px; margin-bottom: 10px; align-items: center; }
    .admin-item-row:last-child { margin-bottom: 0; }
    .admin-item input, .admin-item textarea { font-size: 14px; padding: 12px 14px; background: #fff; }
    .admin-item input[type="number"] { width: 80px; text-align: center; }
    .admin-item textarea { resize: none; height: 60px; }
    .remove-btn {
      width: 40px; height: 40px; border-radius: 10px; border: none;
      background: rgba(255,100,100,0.15); color: #d32f2f; font-size: 20px;
      cursor: pointer; flex-shrink: 0;
    }
    
    /* === åœ–ç‰‡ä¸Šå‚³ === */
    .image-upload-area { display: flex; gap: 10px; align-items: center; }
    .image-preview {
      width: 60px; height: 60px; border-radius: 10px; object-fit: cover;
      background: #fff; flex-shrink: 0; border: 1px solid rgba(0,0,0,0.1);
    }
    .image-preview-placeholder {
      width: 60px; height: 60px; border-radius: 10px;
      background: rgba(255,255,255,0.5); border: 2px dashed rgba(236,64,122,0.3);
      display: flex; align-items: center; justify-content: center;
      font-size: 24px; flex-shrink: 0; cursor: pointer; transition: all 0.2s;
    }
    .image-input-wrapper { flex: 1; display: flex; gap: 8px; }
    .upload-btn {
      padding: 12px 16px; border-radius: 10px; border: 1px solid rgba(102, 126, 234, 0.3);
      background: #fff; color: #5c6ac4; font-size: 14px; font-weight: 600;
      cursor: pointer; white-space: nowrap; transition: all 0.2s;
    }
    .upload-btn.uploading { background: #fff8e1; color: #f57f17; border-color: #ffe0b2; }
    .hidden-file-input {
      position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px;
      overflow: hidden; clip: rect(0,0,0,0); border: 0; opacity: 0; z-index: -1;
    }
    
    /* === çµ±è¨ˆèˆ‡åœ–è¡¨ === */
    .progress-bar { height: 8px; background: rgba(0,0,0,0.05); border-radius: 4px; overflow: hidden; margin-top: 8px; }
    .progress-fill { height: 100%; border-radius: 4px; transition: width 0.3s; }
    .progress-fill.normal { background: linear-gradient(90deg, #4ade80, #10b981); }
    .progress-fill.waitlist { background: linear-gradient(90deg, #fbbf24, #f59e0b); }
    .progress-fill.full { background: #ef4444; }
    
    .stat-card {
      background: rgba(102, 126, 234, 0.05); border-radius: 16px; padding: 20px;
      text-align: center; border: 1px solid rgba(102, 126, 234, 0.2);
    }
    .stat-label { color: #666; font-size: 15px; margin-bottom: 4px; font-weight: 500; }
    .stat-value { font-size: 48px; font-weight: 700; color: #333; }
    
    /* === è¨‚å–®åˆ—è¡¨ === */
    .order-group {
      background: #fff; border-radius: 14px; padding: 16px; margin-bottom: 12px;
      border: 1px solid rgba(0,0,0,0.05); box-shadow: 0 2px 4px rgba(0,0,0,0.02);
    }
    .order-group-header {
      display: flex; justify-content: space-between; align-items: center;
      margin-bottom: 12px; border-bottom: 1px solid #eee; padding-bottom: 8px;
    }
    .order-group-title { font-weight: 700; color: #333; font-size: 16px; }
    .order-group-badge {
      background: #eef2ff; color: #4f46e5; padding: 4px 12px;
      border-radius: 20px; font-size: 13px; font-weight: 600;
    }
    .order-row {
      display: flex; justify-content: space-between; padding: 10px 0;
      border-top: 1px solid #f5f5f5; font-size: 15px;
    }
    .order-row:first-of-type { border-top: none; }
    .order-phone { color: #666; font-family: monospace; }
    .order-items { color: #111; font-weight: 500; }
    
    /* === åº•éƒ¨å°èˆª === */
    .bottom-nav {
      position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
      background: rgba(216, 27, 96, 0.95); border-radius: 50px; padding: 6px;
      display: flex; gap: 4px; backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,0.2); z-index: 100;
      box-shadow: 0 4px 20px rgba(180, 20, 80, 0.4);
    }
    .nav-btn {
      padding: 12px 22px; border-radius: 50px; border: none; background: transparent;
      color: rgba(255,255,255,0.8); font-size: 14px; font-weight: 500;
      cursor: pointer; transition: all 0.2s; font-family: inherit;
    }
    .nav-btn.active {
      background: #fff; color: #d81b60; font-weight: 700;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    }
    
    /* === åº—å®¶ Header === */
    .brand-header {
      text-align: center; margin-bottom: 24px; position: relative;
      background: rgba(255,255,255,0.8); padding: 24px 20px;
      border-radius: 20px; box-shadow: 0 4px 15px rgba(236,64,122,0.1);
      border: 1px solid rgba(255,255,255,0.5);
    }
    .brand-logo {
      width: 120px; height: 120px; background: #fff; border-radius: 50%;
      margin: 0 auto 12px; display: flex; align-items: center; justify-content: center;
      box-shadow: 0 4px 10px rgba(0,0,0,0.08); overflow: hidden;
    }
    .brand-logo img { width: 100%; height: 100%; object-fit: cover; }
    .brand-name { font-size: 15px; font-weight: 500; color: #666; margin-bottom: 4px; letter-spacing: 1px; }
    .group-title { font-size: 28px; font-weight: 800; color: #c2185b; margin-top: 4px; line-height: 1.3; }

    /* === æˆåŠŸç•«é¢ === */
    .success-screen { min-height: 80vh; display: flex; align-items: center; justify-content: center; }
    .success-content {
      text-align: center; background: rgba(255,255,255,0.95); padding: 40px 30px;
      border-radius: 24px; box-shadow: 0 10px 40px rgba(180, 20, 80, 0.15);
      border: 1px solid rgba(255,255,255,1); width: 100%;
    }
    .success-svg {
      width: 80px; height: 80px; fill: #10b981;
      filter: drop-shadow(0 4px 10px rgba(16, 185, 129, 0.2)); margin-bottom: 20px;
    }
    .success-title { font-size: 30px; font-weight: 800; margin-bottom: 20px; color: #1a1a1a; }
    .success-info {
      color: #333; margin-bottom: 24px; line-height: 1.8; font-size: 18px;
      font-weight: 500; background: #f9f9f9; padding: 15px; border-radius: 12px;
    }
    .success-items {
      background: transparent; border-radius: 14px; padding: 10px 0; text-align: center;
      margin-bottom: 24px; border-top: 2px dashed #ddd; border-bottom: 2px dashed #ddd;
    }
    .success-item { color: #000; padding: 8px 0; font-size: 20px; font-weight: 700; }
    
    /* === éŒ¯èª¤èˆ‡è¼‰å…¥ === */
    .error-msg {
      background: #fef2f2; border: 1px solid #fecaca; border-radius: 12px;
      padding: 14px 18px; color: #dc2626; font-size: 15px; font-weight: 500;
      text-align: center; margin-bottom: 16px;
    }
    .loading { text-align: center; padding: 60px 20px; color: #666; }
    .spinner {
      width: 40px; height: 40px; border: 4px solid rgba(0,0,0,0.1);
      border-top-color: #d81b60; border-radius: 50%;
      animation: spin 0.8s linear infinite; margin: 0 auto 16px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    
    .empty-state { text-align: center; padding: 60px 20px; color: #888; }
    .empty-icon { font-size: 56px; margin-bottom: 16px; opacity: 0.5; }
    
    /* === è¤‡è£½é€£çµ === */
    .link-box {
      background: #ecfdf5; border: 1px solid #6ee7b7; border-radius: 12px;
      padding: 16px; margin-top: 20px;
    }
    .link-label { color: #059669; font-size: 14px; font-weight: 700; margin-bottom: 8px; }
    .link-row { display: flex; gap: 10px; }
    .link-input {
      flex: 1; background: #fff; border: 1px solid #d1fae5; color: #333;
      font-size: 14px; padding: 10px; border-radius: 8px;
    }
    
    .copy-btn {
      padding: 12px 20px;
      border-radius: 10px;
      border: 1px solid #ddd;
      background: #f8f9fa;
      color: #666;
      font-weight: 600;
      font-size: 14px;
      cursor: pointer;
      white-space: nowrap;
      transition: all 0.2s;
    }
    .copy-btn:hover { background: #edf2f7; }

    .btn-generate-short {
      margin-top: 12px;
      width: 100%;
      padding: 14px;
      border-radius: 12px;
      border: none;
      background: #10b981;
      color: #ffffff;
      font-size: 16px;
      font-weight: 800;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      transition: all 0.2s;
    }
    .btn-generate-short:hover {
      background: #059669;
      transform: translateY(-1px);
      box-shadow: 0 6px 15px rgba(16, 185, 129, 0.4);
    }
    
    .toast {
      position: fixed; 
      top: 60px;
      left: 50%; 
      transform: translateX(-50%);
      background: #10b981; 
      color: #ffffff; 
      padding: 20px 50px;
      border-radius: 20px;
      font-size: 26px; 
      font-weight: 900; 
      z-index: 9999;
      animation: toastIn 3s ease forwards;
      box-shadow: 0 20px 50px rgba(0,0,0,0.3);
      border: 4px solid #ffffff;
      white-space: nowrap;
      text-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }

    @keyframes toastIn {
      0% { opacity: 0; transform: translateX(-50%) translateY(-50px) scale(0.8); }
      15% { opacity: 1; transform: translateX(-50%) translateY(0) scale(1.1); }
      20% { opacity: 1; transform: translateX(-50%) translateY(0) scale(1); }
      85% { opacity: 1; transform: translateX(-50%) translateY(0) scale(1); }
      100% { opacity: 0; transform: translateX(-50%) translateY(-50px); }
    }
    
    /* === Upload Modal === */
    .upload-modal {
      position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.8); display: flex; align-items: center;
      justify-content: center; z-index: 150; padding: 20px;
    }
    .upload-modal-content {
      background: #fff; border-radius: 20px; padding: 24px;
      width: 100%; max-width: 320px; box-shadow: 0 20px 50px rgba(0,0,0,0.3);
    }
    .upload-modal-title { font-size: 18px; font-weight: 700; text-align: center; margin-bottom: 20px; color: #333; }
    .upload-option {
      display: flex; align-items: center; gap: 14px; padding: 16px;
      background: #f9fafb; border-radius: 12px; margin-bottom: 10px;
      cursor: pointer; transition: all 0.2s; border: 1px solid #eee;
    }
    .upload-option:hover { background: #f3f4f6; border-color: #ddd; }
    .upload-option-icon { font-size: 28px; }
    .upload-option-text { font-size: 16px; color: #333; font-weight: 500; }
    .upload-modal-cancel {
      width: 100%; padding: 14px; border-radius: 12px; border: 1px solid #ddd;
      background: transparent; color: #666; font-size: 15px; cursor: pointer;
      margin-top: 10px; font-weight: 500;
    }
  </style>
</head>
<body>
  <div id="app"></div>
  <div id="toast-container"></div>
  <div id="modal-container"></div>
  <input type="file" id="file-input-camera" accept="image/*" capture="environment" class="hidden-file-input">
  <input type="file" id="file-input-gallery" accept="image/*" class="hidden-file-input">
  <script>
    // ====== é™¤éŒ¯ç”¨ - å®Œæˆå¾Œå¯åˆªé™¤ ======
    window.addEventListener('error', function(e) {
      console.error('JavaScript éŒ¯èª¤ï¼š', e.message, e);
    });
    console.log('âœ… Script é–‹å§‹è¼‰å…¥');

    // ====== è¨­å®š ======
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzZ-AcwAJQcfq8npulJ07SDRuKN7_JSjP-C6Dze6PXRYHUeswZbUwefn2HVvYEsFmWFzw/exec';
    const IMGBB_API_KEY = '3d55c47c2d5b269a2864bd751cdb031e';
    
    const STORES = [
      'ä¸­å’Œ', 'æ–‡å±±', 'æ°¸å’Œ', 'æ—å£', 'å¹³é®', 'å¤è¯', 'å—å¹³', 'è¬è¯', 'ä¸‰å³½',
      'ç’°çƒ', 'å¿ é †', 'æ³°å±±', 'å››è™Ÿå…¬åœ’', 'æ¿æ©‹', 'æ¹–å£', 'æ·¡æ°´', 'æ¾å±±', 'ç¶“åœ‹'
    ];

    // ====== ç‹€æ…‹ç®¡ç† ======
    let state = {
      view: 'login',
      isLoggedIn: false,
      adminMode: 'create',
      currentSheet: localStorage.getItem('currentSheet') || '',
      formConfig: null,
      orders: [],
      loading: false,
      error: '',
      formTitle: '',
      items: [{ name: '', limit: 30, waitlist: 0, image: '', description: '' }],
      selectedStore: '',
      phone: '',
      selectedItems: {},
      successInfo: null,
      uploadingIndex: -1,
      showUploadModal: false,
      uploadTargetIndex: -1,
      shortUrl: localStorage.getItem('shortUrl') || '',
      sheetList: [],
    };

    // ====== åœ–ç‰‡ä¸Šå‚³ (ImgBB) ======
    async function uploadToImgur(file, onProgress) {
      return new Promise(function(resolve, reject) {
        const formData = new FormData();
        formData.append('image', file);
        
        const xhr = new XMLHttpRequest();
        xhr.open('POST', 'https://api.imgbb.com/1/upload?key=' + IMGBB_API_KEY);
        
        xhr.upload.onprogress = function(e) {
          if (e.lengthComputable && onProgress) {
            const percent = Math.round((e.loaded / e.total) * 100);
            onProgress(percent);
          }
        };
        
        xhr.onload = function() {
          if (xhr.status === 200) {
            try {
              const data = JSON.parse(xhr.responseText);
              if (data.success) {
                resolve(data.data.url);
              } else {
                reject(new Error(data.error?.message || 'ä¸Šå‚³å¤±æ•—'));
              }
            } catch (e) {
              reject(new Error('è§£æå›æ‡‰å¤±æ•—'));
            }
          } else {
            reject(new Error('ä¸Šå‚³å¤±æ•—ï¼š' + xhr.status));
          }
        };
        
        xhr.onerror = function() {
          reject(new Error('ç¶²è·¯éŒ¯èª¤'));
        };
        
        xhr.send(formData);
      });
    }

    function showUploadOptions(index) {
      state.showUploadModal = true;
      state.uploadTargetIndex = index;
      renderModal();
    }

    function hideUploadModal() {
      state.showUploadModal = false;
      state.uploadTargetIndex = -1;
      renderModal();
    }

    function triggerCameraUpload() {
      state.showUploadModal = false;
      renderModal();
      setTimeout(function() {
        document.getElementById('file-input-camera').click();
      }, 100);
    }

    function triggerGalleryUpload() {
      state.showUploadModal = false;
      renderModal();
      setTimeout(function() {
        document.getElementById('file-input-gallery').click();
      }, 100);
    }

    async function handleFileSelect(event) {
      const file = event.target.files[0];
      if (!file) return;
      const index = state.uploadTargetIndex;
      if (index < 0) return;
      
      state.uploadingIndex = index;
      render();
      
      showUploadingOverlay(0);
      
      try {
        const imageUrl = await uploadToImgur(file, function(percent) {
          updateUploadProgress(percent);
        });
        state.items[index].image = imageUrl;
        hideUploadingOverlay();
        showToast('âœ… ä¸Šå‚³æˆåŠŸï¼');
      } catch (error) {
        hideUploadingOverlay();
        showToast('âŒ ä¸Šå‚³å¤±æ•—ï¼š' + (error.message || 'è«‹é‡è©¦'));
        console.error(error);
      }
      state.uploadingIndex = -1;
      state.uploadTargetIndex = -1;
      event.target.value = '';
      render();
    }
    
    function showUploadingOverlay(initialPercent) {
      const overlay = document.createElement('div');
      overlay.id = 'uploading-overlay';
      overlay.innerHTML = 
        '<div style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);display:flex;align-items:center;justify-content:center;z-index:300;">' +
          '<div style="background:#fff;border-radius:20px;padding:40px 50px;text-align:center;box-shadow:0 10px 40px rgba(0,0,0,0.3);min-width:280px;">' +
            '<div style="font-size:48px;margin-bottom:16px;">ğŸ“¤</div>' +
            '<div style="font-size:18px;font-weight:600;color:#333;margin-bottom:20px;">åœ–ç‰‡ä¸Šå‚³ä¸­...</div>' +
            '<div style="background:#eee;border-radius:10px;height:20px;overflow:hidden;margin-bottom:12px;">' +
              '<div id="upload-progress-bar" style="background:linear-gradient(90deg,#f48fb1,#ec407a);height:100%;width:' + initialPercent + '%;transition:width 0.3s;border-radius:10px;"></div>' +
            '</div>' +
            '<div id="upload-progress-text" style="font-size:16px;font-weight:700;color:#ec407a;">' + initialPercent + '%</div>' +
          '</div>' +
        '</div>';
      document.body.appendChild(overlay);
    }
    
    function updateUploadProgress(percent) {
      const bar = document.getElementById('upload-progress-bar');
      const text = document.getElementById('upload-progress-text');
      if (bar) bar.style.width = percent + '%';
      if (text) text.textContent = percent + '%';
    }
    
    function hideUploadingOverlay() {
      const overlay = document.getElementById('uploading-overlay');
      if (overlay) overlay.remove();
    }

    document.getElementById('file-input-camera').addEventListener('change', handleFileSelect);
    document.getElementById('file-input-gallery').addEventListener('change', handleFileSelect);

    // ====== Helper Functions ======
    function showToast(message) {
      const container = document.getElementById('toast-container');
      container.innerHTML = '<div class="toast">' + message + '</div>';
      setTimeout(function() { container.innerHTML = ''; }, 2500);
    }

    // ====== Renders ======
    function renderModal() {
      const container = document.getElementById('modal-container');
      if (state.showUploadModal) {
        container.innerHTML = 
          '<div class="upload-modal" onclick="hideUploadModal()">' +
            '<div class="upload-modal-content" onclick="event.stopPropagation()">' +
              '<div class="upload-modal-title">ğŸ“· é¸æ“‡åœ–ç‰‡ä¾†æº</div>' +
              '<div class="upload-option" onclick="triggerCameraUpload()">' +
                '<span class="upload-option-icon">ğŸ“¸</span>' +
                '<span class="upload-option-text">æ‹ç…§</span>' +
              '</div>' +
              '<div class="upload-option" onclick="triggerGalleryUpload()">' +
                '<span class="upload-option-icon">ğŸ–¼ï¸</span>' +
                '<span class="upload-option-text">å¾ç›¸ç°¿é¸æ“‡</span>' +
              '</div>' +
              '<button class="upload-modal-cancel" onclick="hideUploadModal()">å–æ¶ˆ</button>' +
            '</div>' +
          '</div>';
      } else {
        container.innerHTML = '';
      }
    }

    function render() {
      const app = document.getElementById('app');
      let content = '';
      if (state.view === 'login') content = renderLogin();
      else if (state.view === 'admin') content = renderAdmin();
      else if (state.view === 'customer') content = renderCustomer();
      else if (state.view === 'success') content = renderSuccess();
      
      const urlParams = new URLSearchParams(window.location.search);
      if (!urlParams.has('sheet') && state.isLoggedIn) {
        content += renderBottomNav();
      }
      
      app.innerHTML = content;
    }

    function renderLogin() {
      return '<div class="container" style="display:flex;align-items:center;justify-content:center;min-height:80vh;">' +
          '<div class="card" style="width:100%;text-align:center;">' +
            '<div style="font-size:60px;margin-bottom:20px;">ğŸ”’</div>' +
            '<h1>ç®¡ç†å“¡ç™»å…¥</h1>' +
            '<p class="subtitle">è«‹è¼¸å…¥å¯†ç¢¼ä»¥é€²å…¥å¾Œå°</p>' +
            '<div class="form-group">' +
              '<input type="password" id="admin-password" placeholder="è«‹è¼¸å…¥å¯†ç¢¼" style="text-align:center;letter-spacing:4px;">' +
            '</div>' +
            '<button class="btn btn-primary" onclick="doLogin()">ç™»å…¥</button>' +
          '</div>' +
        '</div>';
    }

    function renderAdmin() {
      if (state.adminMode === 'create' || !state.currentSheet) {
        return renderCreateForm();
      } else {
        return renderStats();
      }
    }

    // ç¹¼çºŒè²¼ä¸Šå…¶ä»– render å‡½æ•¸...
    // (renderCreateForm, renderStats, renderCustomer, renderSuccess, renderBottomNav)
    // é€™è£¡å¤ªé•·äº†ï¼Œæˆ‘å…ˆæŠŠæœ€é—œéµçš„ doLogin å’Œ init ä¿®æ­£çµ¦ä½ 

    // ... (ä¸­é–“çœç•¥ï¼Œä¿æŒä½ åŸæœ¬çš„ render å‡½æ•¸ä¸è®Š) ...

    // ====== Actions ======
    async function doLogin() {
      const pwd = document.getElementById('admin-password').value;
      if (!pwd) return;
      
      state.loading = true;
      const btn = document.querySelector('.btn-primary');
      if(btn) btn.innerText = 'é©—è­‰ä¸­...';

      try {
        const response = await fetch(SCRIPT_URL, {
          method: 'POST',
          body: JSON.stringify({ action: 'login', password: pwd })
        });
        const result = await response.json();
        
        if (result.success) {
          state.isLoggedIn = true;
          state.view = 'admin';
          localStorage.setItem('isAdminLoggedIn', 'true');
          
          render();
          
          await loadSheetList();
          if (state.currentSheet) {
            await loadOrders();
          }
          
        } else {
          showToast('âŒ å¯†ç¢¼éŒ¯èª¤');
          if(btn) btn.innerText = 'ç™»å…¥';
        }
      } catch (e) {
        showToast('âŒ é€£ç·šéŒ¯èª¤');
        if(btn) btn.innerText = 'ç™»å…¥';
        console.error(e);
      }
      
      state.loading = false;
    }

    async function loadSheetList() {
      try {
        const response = await fetch(SCRIPT_URL + '?action=getSheetList');
        const result = await response.json();
        if (result.success) {
          state.sheetList = result.sheetNames;
        } else {
          console.error('è¼‰å…¥åˆ†é æ¸…å–®å¤±æ•—:', result.error);
          state.sheetList = [];
        }
      } catch (error) {
        console.error('ç„¡æ³•å–å¾—åˆ†é æ¸…å–®', error);
        state.sheetList = [];
      }
      render();
    }

    async function init() {
      console.log('âœ… init() é–‹å§‹åŸ·è¡Œ');
      const urlParams = new URLSearchParams(window.location.search);
      const sheetParam = urlParams.get('sheet');
      
      if (sheetParam) {
        state.currentSheet = sheetParam;
        state.view = 'customer';
        localStorage.setItem('currentSheet', sheetParam);
        render();
        loadFormData();
      } else {
        const storedLogin = localStorage.getItem('isAdminLoggedIn');
        
        if (storedLogin === 'true') {
          state.isLoggedIn = true;
          state.view = 'admin'; 
          state.adminMode = 'stats';
          
          render();
          
          await loadSheetList();
          if (state.currentSheet) {
            await loadOrders();
          }
        } else {
          state.view = 'login';
          render();
        }
      }
    }

    // ... (ä¿ç•™ä½ æ‰€æœ‰å…¶ä»–çš„å‡½æ•¸) ...

    init();
  </script>

    async function doLogin() {
  const pwd = document.getElementById('admin-password').value;
  if (!pwd) return;
  
  state.loading = true;
  const btn = document.querySelector('.btn-primary');
  if(btn) btn.innerText = 'é©—è­‰ä¸­...';

  try {
    const response = await fetch(SCRIPT_URL, {
      method: 'POST',
      body: JSON.stringify({ action: 'login', password: pwd })
    });
    const result = await response.json();
    
    if (result.success) {
      state.isLoggedIn = true;
      state.view = 'admin';
      localStorage.setItem('isAdminLoggedIn', 'true');
      
      // âœ… å…ˆæ¸²æŸ“ä¸€æ¬¡ï¼ˆé¡¯ç¤ºè¼‰å…¥ä¸­ï¼‰
      render();
      
      // âœ… ç„¶å¾ŒéåŒæ­¥è¼‰å…¥è³‡æ–™ï¼ˆä¸è¦ç«‹å³ renderï¼‰
      await loadSheetList();
      if (state.currentSheet) {
        await loadOrders();
      }
      // loadSheetList() å…§éƒ¨æœƒè‡ªå‹• render()
      
    } else {
      showToast('âŒ å¯†ç¢¼éŒ¯èª¤');
      if(btn) btn.innerText = 'ç™»å…¥';
    }
  } catch (e) {
    showToast('âŒ é€£ç·šéŒ¯èª¤');
    if(btn) btn.innerText = 'ç™»å…¥';
  }
  state.loading = false;
}
      } catch (e) {
        showToast('âŒ é€£ç·šéŒ¯èª¤');
        if(btn) btn.innerText = 'ç™»å…¥';
      }
      state.loading = false;
    }

    // ç™»å‡ºåŠŸèƒ½
    function logout() {
      localStorage.removeItem('isAdminLoggedIn');
      state.isLoggedIn = false;
      state.view = 'login';
      state.currentSheet = '';
      state.orders = [];
      state.formConfig = null;
      
      render();
      showToast('ğŸ”’ å·²å®‰å…¨ç™»å‡º');
    }

    function switchAdminSheet(sheetName) {
      state.currentSheet = sheetName;
      localStorage.setItem('currentSheet', sheetName);
      state.shortUrl = ''; 
      localStorage.removeItem('shortUrl');
      loadOrders(); 
    }

    init();
  </script>
</body>
</html>
