<!DOCTYPE html>
<html lang="zh-TW">
<head>
Â  <meta charset="UTF-8">
Â  <meta name="viewport" content="width=device-width, initial-scale=1.0">
Â  <title>åŒ…å­åª½é–‹åœ˜ç³»çµ±</title>
Â  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
Â  <style>
Â  Â  /* === åŸºç¤è¨­å®š === */
Â  Â  * { margin: 0; padding: 0; box-sizing: border-box; }
Â  Â  body {
Â  Â  Â  font-family: 'Noto Sans TC', sans-serif;
Â  Â  Â  background: linear-gradient(135deg, #fff5f5 0%, #fce4ec 50%, #f8bbd9 100%);
Â  Â  Â  min-height: 100vh;
Â  Â  Â  color: #2c2c2c;Â 
Â  Â  }
Â  Â  .container { max-width: 540px; margin: 0 auto; padding: 20px; padding-bottom: 100px; }
Â  Â Â 
Â  Â  /* === å¡ç‰‡èˆ‡å®¹å™¨ === */
Â  Â  .card {
Â  Â  Â  background: rgba(255,255,255,0.9);
Â  Â  Â  border-radius: 20px;
Â  Â  Â  padding: 24px;
Â  Â  Â  border: 1px solid rgba(236,64,122,0.15);
Â  Â  Â  margin-bottom: 20px;
Â  Â  Â  box-shadow: 0 8px 32px rgba(236,64,122,0.1);
Â  Â  }
Â  Â Â 
Â  Â  /* === æ–‡å­—æ’ç‰ˆ === */
Â  Â  h1 { font-size: 24px; font-weight: 700; text-align: center; margin-bottom: 8px; color: #1a1a1a; }
Â  Â  .subtitle { color: #884455; text-align: center; font-size: 15px; margin-bottom: 28px; font-weight: 500; }
Â  Â  label { display: block; color: #442222; font-size: 15px; font-weight: 700; margin-bottom: 8px; }
Â  Â Â 
Â  Â  /* === è¼¸å…¥å…ƒä»¶ === */
Â  Â  input, select, textarea {
Â  Â  Â  width: 100%; padding: 14px 16px; border-radius: 12px;
Â  Â  Â  border: 1px solid rgba(236,64,122,0.3); background: #fff;
Â  Â  Â  color: #000; font-size: 16px; font-family: inherit; outline: none;
Â  Â  Â  transition: border-color 0.2s; font-weight: 500;
Â  Â  }
Â  Â  input:focus, select:focus, textarea:focus { border-color: #ec407a; background: #fffafa; }
Â  Â  input::placeholder, textarea::placeholder { color: #997b80; }
Â  Â Â 
Â  Â  select {
Â  Â  Â  cursor: pointer; appearance: none;
Â  Â  Â  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%23ec407a' viewBox='0 0 16 16'%3E%3Cpath d='M8 11L3 6h10l-5 5z'/%3E%3C/svg%3E");
Â  Â  Â  background-repeat: no-repeat; background-position: right 16px center;
Â  Â  }
Â  Â  select option { background: #fff; color: #000; }
Â  Â Â 
Â  Â  /* === æŒ‰éˆ• === */
Â  Â  .btn {
Â  Â  Â  width: 100%;Â 
Â  Â  Â  padding: 18px 24px;Â 
Â  Â  Â  border-radius: 14px;Â 
Â  Â  Â  border: none;
Â  Â  Â  font-size: 18px;Â 
Â  Â  Â  font-weight: 700;Â 
Â  Â  Â  cursor: pointer;
Â  Â  Â  transition: all 0.2s;Â 
Â  Â  Â  font-family: inherit;
Â  Â  Â  display: block;Â 
Â  Â  Â  text-align: center;
Â  Â  Â  margin-top: 12px;
Â  Â  }
Â  Â  .btn-primary {
Â  Â  Â  background: linear-gradient(135deg, #f48fb1 0%, #ec407a 100%);
Â  Â  Â  color: #fff;Â 
Â  Â  Â  box-shadow: 0 8px 32px rgba(236,64,122,0.35);
Â  Â  Â  text-shadow: 0 1px 2px rgba(0,0,0,0.1);
Â  Â  }
Â  Â  .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 12px 40px rgba(236,64,122,0.45); }
Â  Â  .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
Â  Â Â 
Â  Â  .btn-outline {Â 
Â  Â  Â  background: #fff;Â 
Â  Â  Â  border: 2px dashed #ec407a;Â 
Â  Â  Â  color: #d81b60;
Â  Â  }
Â  Â  .btn-outline:hover { border-color: #d81b60; background: rgba(236,64,122,0.05); }
Â  Â Â 
Â  Â  .form-group { margin-bottom: 20px; }
Â  Â Â 
Â  Â  /* === å“é …å¡ç‰‡ === */
Â  Â  .item-card {
Â  Â  Â  background: #fff; border-radius: 16px; padding: 16px;
Â  Â  Â  margin-bottom: 12px; border: 1px solid rgba(236,64,122,0.2);
Â  Â  Â  box-shadow: 0 2px 8px rgba(0,0,0,0.03);
Â  Â  }
Â  Â  .item-card.sold-out { background: #fff0f0; border-color: #ffcccc; }
Â  Â  .item-card.waitlist { background: #fffbeb; border-color: #fcd34d; }
Â  Â Â 
Â  Â  .item-header { display: flex; gap: 14px; margin-bottom: 12px; }
Â  Â  .item-image {
Â  Â  Â  width: 72px; height: 72px; border-radius: 12px; object-fit: cover;
Â  Â  Â  background: #f5f5f5; flex-shrink: 0; border: 1px solid rgba(0,0,0,0.05);
Â  Â  }
Â  Â  .item-image-placeholder {
Â  Â  Â  width: 72px; height: 72px; border-radius: 12px;
Â  Â  Â  background: rgba(236,64,122,0.08); display: flex;
Â  Â  Â  align-items: center; justify-content: center; font-size: 28px; flex-shrink: 0;
Â  Â  }
Â  Â  .item-info { flex: 1; min-width: 0; }
Â  Â  .item-name { font-size: 18px; font-weight: 700; margin-bottom: 4px; color: #222; }
Â  Â  .item-desc {
Â  Â  Â  font-size: 14px; color: #555; line-height: 1.4;
Â  Â  Â  display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical;
Â  Â  Â  overflow: hidden; margin-bottom: 4px;
Â  Â  }
Â  Â  .item-stock { font-size: 13px; margin-top: 6px; font-weight: 500; }
Â  Â  .item-stock.available { color: #d81b60; }
Â  Â  .item-stock.sold-out { color: #d32f2f; }
Â  Â  .item-stock.waitlist { color: #d97706; }
Â  Â Â 
Â  Â  .item-controls { display: flex; align-items: center; justify-content: flex-end; gap: 14px; }
Â  Â  .qty-btn {
Â  Â  Â  width: 38px; height: 38px; border-radius: 10px;
Â  Â  Â  border: 1px solid rgba(236,64,122,0.2); background: #fff;
Â  Â  Â  color: #d81b60; font-size: 20px; cursor: pointer; transition: all 0.2s;
Â  Â  }
Â  Â  .qty-btn:hover { background: #fff0f5; border-color: #ec407a; }
Â  Â  .qty-btn.plus { background: linear-gradient(135deg, #f48fb1 0%, #ec407a 100%); color: #fff; border: none; }
Â  Â  .qty-btn:disabled { opacity: 0.3; cursor: not-allowed; border-color: #ddd; color: #999; }
Â  Â  .qty-display { font-size: 20px; font-weight: 700; min-width: 28px; text-align: center; color: #333; }
Â  Â Â 
Â  Â  /* === ç®¡ç†å“¡ä»‹é¢ === */
Â  Â  .admin-item {
Â  Â  Â  background: rgba(255,255,255,0.5); border-radius: 16px;
Â  Â  Â  padding: 16px; margin-bottom: 12px; border: 1px solid rgba(0,0,0,0.1);
Â  Â  }
Â  Â  .admin-item-row { display: flex; gap: 10px; margin-bottom: 10px; align-items: center; }
Â  Â  .admin-item-row:last-child { margin-bottom: 0; }
Â  Â  .admin-item input, .admin-item textarea { font-size: 14px; padding: 12px 14px; background: #fff; }
Â  Â  .admin-item input[type="number"] { width: 80px; text-align: center; }
Â  Â  .admin-item textarea { resize: none; height: 60px; }
Â  Â  .remove-btn {
Â  Â  Â  width: 40px; height: 40px; border-radius: 10px; border: none;
Â  Â  Â  background: rgba(255,100,100,0.15); color: #d32f2f; font-size: 20px;
Â  Â  Â  cursor: pointer; flex-shrink: 0;
Â  Â  }
Â  Â Â 
Â  Â  /* === åœ–ç‰‡ä¸Šå‚³ === */
Â  Â  .image-upload-area { display: flex; gap: 10px; align-items: center; }
Â  Â  .image-preview {
Â  Â  Â  width: 60px; height: 60px; border-radius: 10px; object-fit: cover;
Â  Â  Â  background: #fff; flex-shrink: 0; border: 1px solid rgba(0,0,0,0.1);
Â  Â  }
Â  Â  .image-preview-placeholder {
Â  Â  Â  width: 60px; height: 60px; border-radius: 10px;
Â  Â  Â  background: rgba(255,255,255,0.5); border: 2px dashed rgba(236,64,122,0.3);
Â  Â  Â  display: flex; align-items: center; justify-content: center;
Â  Â  Â  font-size: 24px; flex-shrink: 0; cursor: pointer; transition: all 0.2s;
Â  Â  }
Â  Â  .image-input-wrapper { flex: 1; display: flex; gap: 8px; }
Â  Â  .upload-btn {
Â  Â  Â  padding: 12px 16px; border-radius: 10px; border: 1px solid rgba(102, 126, 234, 0.3);
Â  Â  Â  background: #fff; color: #5c6ac4; font-size: 14px; font-weight: 600;
Â  Â  Â  cursor: pointer; white-space: nowrap; transition: all 0.2s;
Â  Â  }
Â  Â  .upload-btn.uploading { background: #fff8e1; color: #f57f17; border-color: #ffe0b2; }
Â  Â  .hidden-file-input {
Â  Â  Â  position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px;
Â  Â  Â  overflow: hidden; clip: rect(0,0,0,0); border: 0; opacity: 0; z-index: -1;
Â  Â  }
Â  Â Â 
Â  Â  /* === çµ±è¨ˆèˆ‡åœ–è¡¨ === */
Â  Â  .progress-bar { height: 8px; background: rgba(0,0,0,0.05); border-radius: 4px; overflow: hidden; margin-top: 8px; }
Â  Â  .progress-fill { height: 100%; border-radius: 4px; transition: width 0.3s; }
Â  Â  .progress-fill.normal { background: linear-gradient(90deg, #4ade80, #10b981); }
Â  Â  .progress-fill.waitlist { background: linear-gradient(90deg, #fbbf24, #f59e0b); }
Â  Â  .progress-fill.full { background: #ef4444; }
Â  Â Â 
Â  Â  .stat-card {
Â  Â  Â  background: rgba(102, 126, 234, 0.05); border-radius: 16px; padding: 20px;
Â  Â  Â  text-align: center; border: 1px solid rgba(102, 126, 234, 0.2);
Â  Â  }
Â  Â  .stat-label { color: #666; font-size: 15px; margin-bottom: 4px; font-weight: 500; }
Â  Â  .stat-value { font-size: 48px; font-weight: 700; color: #333; }
Â  Â Â 
Â  Â  /* === è¨‚å–®åˆ—è¡¨ === */
Â  Â  .order-group {
Â  Â  Â  background: #fff; border-radius: 14px; padding: 16px; margin-bottom: 12px;
Â  Â  Â  border: 1px solid rgba(0,0,0,0.05); box-shadow: 0 2px 4px rgba(0,0,0,0.02);
Â  Â  }
Â  Â  .order-group-header {
Â  Â  Â  display: flex; justify-content: space-between; align-items: center;
Â  Â  Â  margin-bottom: 12px; border-bottom: 1px solid #eee; padding-bottom: 8px;
Â  Â  }
Â  Â  .order-group-title { font-weight: 700; color: #333; font-size: 16px; }
Â  Â  .order-group-badge {
Â  Â  Â  background: #eef2ff; color: #4f46e5; padding: 4px 12px;
Â  Â  Â  border-radius: 20px; font-size: 13px; font-weight: 600;
Â  Â  }
Â  Â  .order-row {
Â  Â  Â  display: flex; justify-content: space-between; padding: 10px 0;
Â  Â  Â  border-top: 1px solid #f5f5f5; font-size: 15px;
Â  Â  }
Â  Â  .order-row:first-of-type { border-top: none; }
Â  Â  .order-phone { color: #666; font-family: monospace; }
Â  Â  .order-items { color: #111; font-weight: 500; }
Â  Â Â 
Â  Â  /* === åº•éƒ¨å°èˆª === */
Â  Â  .bottom-nav {
Â  Â  Â  position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
Â  Â  Â  background: rgba(216, 27, 96, 0.95); border-radius: 50px; padding: 6px;
Â  Â  Â  display: flex; gap: 4px; backdrop-filter: blur(10px);
Â  Â  Â  border: 1px solid rgba(255,255,255,0.2); z-index: 100;
Â  Â  Â  box-shadow: 0 4px 20px rgba(180, 20, 80, 0.4);
Â  Â  }
Â  Â  .nav-btn {
Â  Â  Â  padding: 12px 22px; border-radius: 50px; border: none; background: transparent;
Â  Â  Â  color: rgba(255,255,255,0.8); font-size: 14px; font-weight: 500;
Â  Â  Â  cursor: pointer; transition: all 0.2s; font-family: inherit;
Â  Â  }
Â  Â  .nav-btn.active {
Â  Â  Â  background: #fff; color: #d81b60; font-weight: 700;
Â  Â  Â  box-shadow: 0 2px 10px rgba(0,0,0,0.2);
Â  Â  }
Â  Â Â 
Â  Â  /* === åº—å®¶ Header === */
Â  Â  .brand-header {
Â  Â  Â  text-align: center; margin-bottom: 24px; position: relative;
Â  Â  Â  background: rgba(255,255,255,0.8); padding: 24px 20px;
Â  Â  Â  border-radius: 20px; box-shadow: 0 4px 15px rgba(236,64,122,0.1);
Â  Â  Â  border: 1px solid rgba(255,255,255,0.5);
Â  Â  }
Â  Â  .brand-logo {
Â  Â  Â  width: 120px; height: 120px; background: #fff; border-radius: 50%;
Â  Â  Â  margin: 0 auto 12px; display: flex; align-items: center; justify-content: center;
Â  Â  Â  box-shadow: 0 4px 10px rgba(0,0,0,0.08); overflow: hidden;
Â  Â  }
Â  Â  .brand-logo img { width: 100%; height: 100%; object-fit: cover; }
Â  Â  .brand-name { font-size: 15px; font-weight: 500; color: #666; margin-bottom: 4px; letter-spacing: 1px; }
Â  Â  .group-title { font-size: 28px; font-weight: 800; color: #c2185b; margin-top: 4px; line-height: 1.3; }

Â  Â  /* === æˆåŠŸç•«é¢ === */
Â  Â  .success-screen { min-height: 80vh; display: flex; align-items: center; justify-content: center; }
Â  Â  .success-content {
Â  Â  Â  text-align: center; background: rgba(255,255,255,0.95); padding: 40px 30px;
Â  Â  Â  border-radius: 24px; box-shadow: 0 10px 40px rgba(180, 20, 80, 0.15);
Â  Â  Â  border: 1px solid rgba(255,255,255,1); width: 100%;
Â  Â  }
Â  Â  .success-svg {
Â  Â  Â  width: 80px; height: 80px; fill: #10b981;
Â  Â  Â  filter: drop-shadow(0 4px 10px rgba(16, 185, 129, 0.2)); margin-bottom: 20px;
Â  Â  }
Â  Â  .success-title { font-size: 30px; font-weight: 800; margin-bottom: 20px; color: #1a1a1a; }
Â  Â  .success-info {
Â  Â  Â  color: #333; margin-bottom: 24px; line-height: 1.8; font-size: 18px;
Â  Â  Â  font-weight: 500; background: #f9f9f9; padding: 15px; border-radius: 12px;
Â  Â  }
Â  Â  .success-items {
Â  Â  Â  background: transparent; border-radius: 14px; padding: 10px 0; text-align: center;
Â  Â  Â  margin-bottom: 24px; border-top: 2px dashed #ddd; border-bottom: 2px dashed #ddd;
Â  Â  }
Â  Â  .success-item { color: #000; padding: 8px 0; font-size: 20px; font-weight: 700; }
Â  Â Â 
Â  Â  /* === éŒ¯èª¤èˆ‡è¼‰å…¥ === */
Â  Â  .error-msg {
Â  Â  Â  background: #fef2f2; border: 1px solid #fecaca; border-radius: 12px;
Â  Â  Â  padding: 14px 18px; color: #dc2626; font-size: 15px; font-weight: 500;
Â  Â  Â  text-align: center; margin-bottom: 16px;
Â  Â  }
Â  Â  .loading { text-align: center; padding: 60px 20px; color: #666; }
Â  Â  .spinner {
Â  Â  Â  width: 40px; height: 40px; border: 4px solid rgba(0,0,0,0.1);
Â  Â  Â  border-top-color: #d81b60; border-radius: 50%;
Â  Â  Â  animation: spin 0.8s linear infinite; margin: 0 auto 16px;
Â  Â  }
Â  Â  @keyframes spin { to { transform: rotate(360deg); } }
Â  Â Â 
Â  Â  .empty-state { text-align: center; padding: 60px 20px; color: #888; }
Â  Â  .empty-icon { font-size: 56px; margin-bottom: 16px; opacity: 0.5; }
Â  Â Â 
Â  Â  /* === è¤‡è£½é€£çµ === */
Â  Â  .link-box {
Â  Â  Â  background: #ecfdf5; border: 1px solid #6ee7b7; border-radius: 12px;
Â  Â  Â  padding: 16px; margin-top: 20px;
Â  Â  }
Â  Â  .link-label { color: #059669; font-size: 14px; font-weight: 700; margin-bottom: 8px; }
Â  Â  .link-row { display: flex; gap: 10px; }
Â  Â  .link-input {
Â  Â  Â  flex: 1; background: #fff; border: 1px solid #d1fae5; color: #333;
Â  Â  Â  font-size: 14px; padding: 10px; border-radius: 8px;
Â  Â  }
Â  Â Â 
Â  Â  .copy-btn {
Â  Â  Â  padding: 12px 20px;
Â  Â  Â  border-radius: 10px;
Â  Â  Â  border: 1px solid #ddd;
Â  Â  Â  background: #f8f9fa;
Â  Â  Â  color: #666;
Â  Â  Â  font-weight: 600;
Â  Â  Â  font-size: 14px;
Â  Â  Â  cursor: pointer;
Â  Â  Â  white-space: nowrap;
Â  Â  Â  transition: all 0.2s;
Â  Â  }
Â  Â  .copy-btn:hover { background: #edf2f7; }

Â  Â  .btn-generate-short {
Â  Â  Â  margin-top: 12px;
Â  Â  Â  width: 100%;
Â  Â  Â  padding: 14px;
Â  Â  Â  border-radius: 12px;
Â  Â  Â  border: none;
Â  Â  Â  background: #10b981;
Â  Â  Â  color: #ffffff;
Â  Â  Â  font-size: 16px;
Â  Â  Â  font-weight: 800;
Â  Â  Â  cursor: pointer;
Â  Â  Â  box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
Â  Â  Â  display: flex;
Â  Â  Â  align-items: center;
Â  Â  Â  justify-content: center;
Â  Â  Â  gap: 8px;
Â  Â  Â  transition: all 0.2s;
Â  Â  }
Â  Â  .btn-generate-short:hover {
Â  Â  Â  background: #059669;
Â  Â  Â  transform: translateY(-1px);
Â  Â  Â  box-shadow: 0 6px 15px rgba(16, 185, 129, 0.4);
Â  Â  }
Â  Â Â 
Â  Â  .toast {
Â  Â  Â  position: fixed;Â 
Â  Â  Â  top: 60px;
Â  Â  Â  left: 50%;Â 
Â  Â  Â  transform: translateX(-50%);
Â  Â  Â  background: #10b981;Â 
Â  Â  Â  color: #ffffff;Â 
Â  Â  Â  padding: 20px 50px;
Â  Â  Â  border-radius: 20px;
Â  Â  Â  font-size: 26px;Â 
Â  Â  Â  font-weight: 900;Â 
Â  Â  Â  z-index: 9999;
Â  Â  Â  animation: toastIn 3s ease forwards;
Â  Â  Â  box-shadow: 0 20px 50px rgba(0,0,0,0.3);
Â  Â  Â  border: 4px solid #ffffff;
Â  Â  Â  white-space: nowrap;
Â  Â  Â  text-shadow: 0 2px 4px rgba(0,0,0,0.2);
Â  Â  }

Â  Â  @keyframes toastIn {
Â  Â  Â  0% { opacity: 0; transform: translateX(-50%) translateY(-50px) scale(0.8); }
Â  Â  Â  15% { opacity: 1; transform: translateX(-50%) translateY(0) scale(1.1); }
Â  Â  Â  20% { opacity: 1; transform: translateX(-50%) translateY(0) scale(1); }
Â  Â  Â  85% { opacity: 1; transform: translateX(-50%) translateY(0) scale(1); }
Â  Â  Â  100% { opacity: 0; transform: translateX(-50%) translateY(-50px); }
Â  Â  }
Â  Â Â 
Â  Â  /* === Upload Modal === */
Â  Â  .upload-modal {
Â  Â  Â  position: fixed; top: 0; left: 0; right: 0; bottom: 0;
Â  Â  Â  background: rgba(0,0,0,0.8); display: flex; align-items: center;
Â  Â  Â  justify-content: center; z-index: 150; padding: 20px;
Â  Â  }
Â  Â  .upload-modal-content {
Â  Â  Â  background: #fff; border-radius: 20px; padding: 24px;
Â  Â  Â  width: 100%; max-width: 320px; box-shadow: 0 20px 50px rgba(0,0,0,0.3);
Â  Â  }
Â  Â  .upload-modal-title { font-size: 18px; font-weight: 700; text-align: center; margin-bottom: 20px; color: #333; }
Â  Â  .upload-option {
Â  Â  Â  display: flex; align-items: center; gap: 14px; padding: 16px;
Â  Â  Â  background: #f9fafb; border-radius: 12px; margin-bottom: 10px;
Â  Â  Â  cursor: pointer; transition: all 0.2s; border: 1px solid #eee;
Â  Â  }
Â  Â  .upload-option:hover { background: #f3f4f6; border-color: #ddd; }
Â  Â  .upload-option-icon { font-size: 28px; }
Â  Â  .upload-option-text { font-size: 16px; color: #333; font-weight: 500; }
Â  Â  .upload-modal-cancel {
Â  Â  Â  width: 100%; padding: 14px; border-radius: 12px; border: 1px solid #ddd;
Â  Â  Â  background: transparent; color: #666; font-size: 15px; cursor: pointer;
Â  Â  Â  margin-top: 10px; font-weight: 500;
Â  Â  }
Â  </style>
</head>
<body>
Â  <div id="app"></div>
Â  <div id="toast-container"></div>
Â  <div id="modal-container"></div>
Â  <input type="file" id="file-input-camera" accept="image/*" capture="environment" class="hidden-file-input">
Â  <input type="file" id="file-input-gallery" accept="image/*" class="hidden-file-input">
Â  <script>
Â  Â  // ====== é™¤éŒ¯ç”¨ - å®Œæˆå¾Œå¯åˆªé™¤ ======
window.addEventListener('error', function(e) {
Â  alert('JavaScript éŒ¯èª¤ï¼š' + e.message);
Â  console.error('éŒ¯èª¤è©³æƒ…ï¼š', e);
});

console.log('âœ… Script é–‹å§‹è¼‰å…¥');
Â  Â  // ====== è¨­å®š ======
Â  Â  const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzZ-AcwAJQcfq8npulJ07SDRuKN7_JSjP-C6Dze6PXRYHUeswZbUwefn2HVvYEsFmWFzw/exec';
Â  Â  const IMGBB_API_KEY = '3d55c47c2d5b269a2864bd751cdb031e';
Â  Â Â 
Â  Â  const STORES = [
Â  Â  Â  'ä¸­å’Œ', 'æ–‡å±±', 'æ°¸å’Œ', 'æ—å£', 'å¹³é®', 'å¤è¯', 'å—å¹³', 'è¬è¯', 'ä¸‰å³½',
Â  Â  Â  'ç’°çƒ', 'å¿ é †', 'æ³°å±±', 'å››è™Ÿå…¬åœ’', 'æ¿æ©‹', 'æ¹–å£', 'æ·¡æ°´', 'æ¾å±±', 'ç¶“åœ‹'
Â  Â  ];

Â  Â  // ====== ç‹€æ…‹ç®¡ç† ======
Â  Â  let state = {
Â  Â  Â  view: 'login', // é è¨­æ”¹ç‚º login
Â  Â  Â  isLoggedIn: false, // â˜… æ–°å¢ï¼šç™»å…¥ç‹€æ…‹
Â  Â  Â  adminMode: 'create',
Â  Â  Â  currentSheet: localStorage.getItem('currentSheet') || '',
Â  Â  Â  formConfig: null,
Â  Â  Â  orders: [],
Â  Â  Â  loading: false,
Â  Â  Â  error: '',
Â  Â  Â  formTitle: '',
Â  Â  Â  items: [{ name: '', limit: 30, waitlist: 0, image: '', description: '' }], // åŠ å…¥ waitlist
Â  Â  Â  selectedStore: '',
Â  Â  Â  phone: '',
Â  Â  Â  selectedItems: {},
Â  Â  Â  successInfo: null,
Â  Â  Â  uploadingIndex: -1,
Â  Â  Â  showUploadModal: false,
Â  Â  Â  uploadTargetIndex: -1,
Â  Â  Â  shortUrl: localStorage.getItem('shortUrl') || '',
Â  Â  Â  sheetList: [], // â˜… æ–°å¢åˆ†é æ¸…å–®
Â  Â  };

Â  Â  // ====== åœ–ç‰‡ä¸Šå‚³ (ImgBB) ======
Â  Â  async function uploadToImgur(file, onProgress) {
Â  Â  Â  return new Promise(function(resolve, reject) {
Â  Â  Â  Â  const formData = new FormData();
Â  Â  Â  Â  formData.append('image', file);
Â  Â  Â  Â Â 
Â  Â  Â  Â  const xhr = new XMLHttpRequest();
Â  Â  Â  Â  xhr.open('POST', 'https://api.imgbb.com/1/upload?key=' + IMGBB_API_KEY);
Â  Â  Â  Â Â 
Â  Â  Â  Â  xhr.upload.onprogress = function(e) {
Â  Â  Â  Â  Â  if (e.lengthComputable && onProgress) {
Â  Â  Â  Â  Â  Â  const percent = Math.round((e.loaded / e.total) * 100);
Â  Â  Â  Â  Â  Â  onProgress(percent);
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  };
Â  Â  Â  Â Â 
Â  Â  Â  Â  xhr.onload = function() {
Â  Â  Â  Â  Â  if (xhr.status === 200) {
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  const data = JSON.parse(xhr.responseText);
Â  Â  Â  Â  Â  Â  Â  if (data.success) {
Â  Â  Â  Â  Â  Â  Â  Â  resolve(data.data.url);
Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  reject(new Error(data.error?.message || 'ä¸Šå‚³å¤±æ•—'));
Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  } catch (e) {
Â  Â  Â  Â  Â  Â  Â  reject(new Error('è§£æå›æ‡‰å¤±æ•—'));
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  reject(new Error('ä¸Šå‚³å¤±æ•—ï¼š' + xhr.status));
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  };
Â  Â  Â  Â Â 
Â  Â  Â  Â  xhr.onerror = function() {
Â  Â  Â  Â  Â  reject(new Error('ç¶²è·¯éŒ¯èª¤'));
Â  Â  Â  Â  };
Â  Â  Â  Â Â 
Â  Â  Â  Â  xhr.send(formData);
Â  Â  Â  });
Â  Â  }

Â  Â  function showUploadOptions(index) {
Â  Â  Â  state.showUploadModal = true;
Â  Â  Â  state.uploadTargetIndex = index;
Â  Â  Â  renderModal();
Â  Â  }
Â  Â  function hideUploadModal() {
Â  Â  Â  state.showUploadModal = false;
Â  Â  Â  state.uploadTargetIndex = -1;
Â  Â  Â  renderModal();
Â  Â  }
Â  Â  function triggerCameraUpload() {
Â  Â  Â  state.showUploadModal = false;
Â  Â  Â  renderModal();
Â  Â  Â  setTimeout(function() {
Â  Â  Â  Â  document.getElementById('file-input-camera').click();
Â  Â  Â  }, 100);
Â  Â  }
Â  Â  function triggerGalleryUpload() {
Â  Â  Â  state.showUploadModal = false;
Â  Â  Â  renderModal();
Â  Â  Â  setTimeout(function() {
Â  Â  Â  Â  document.getElementById('file-input-gallery').click();
Â  Â  Â  }, 100);
Â  Â  }
Â  Â  async function handleFileSelect(event) {
Â  Â  Â  const file = event.target.files[0];
Â  Â  Â  if (!file) return;
Â  Â  Â  const index = state.uploadTargetIndex;
Â  Â  Â  if (index < 0) return;
Â  Â  Â Â 
Â  Â  Â  state.uploadingIndex = index;
Â  Â  Â  render();
Â  Â  Â Â 
Â  Â  Â  showUploadingOverlay(0);
Â  Â  Â Â 
Â  Â  Â  try {
Â  Â  Â  Â  const imageUrl = await uploadToImgur(file, function(percent) {
Â  Â  Â  Â  Â  updateUploadProgress(percent);
Â  Â  Â  Â  });
Â  Â  Â  Â  state.items[index].image = imageUrl;
Â  Â  Â  Â  hideUploadingOverlay();
Â  Â  Â  Â  showToast('âœ… ä¸Šå‚³æˆåŠŸï¼');
Â  Â  Â  } catch (error) {
Â  Â  Â  Â  hideUploadingOverlay();
Â  Â  Â  Â  showToast('âŒ ä¸Šå‚³å¤±æ•—ï¼š' + (error.message || 'è«‹é‡è©¦'));
Â  Â  Â  Â  console.error(error);
Â  Â  Â  }
Â  Â  Â  state.uploadingIndex = -1;
Â  Â  Â  state.uploadTargetIndex = -1;
Â  Â  Â  event.target.value = '';
Â  Â  Â  render();
Â  Â  }
Â  Â Â 
Â  Â  function showUploadingOverlay(initialPercent) {
Â  Â  Â  const overlay = document.createElement('div');
Â  Â  Â  overlay.id = 'uploading-overlay';
Â  Â  Â  overlay.innerHTML =Â 
Â  Â  Â  Â  '<div style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);display:flex;align-items:center;justify-content:center;z-index:300;">' +
Â  Â  Â  Â  Â  '<div style="background:#fff;border-radius:20px;padding:40px 50px;text-align:center;box-shadow:0 10px 40px rgba(0,0,0,0.3);min-width:280px;">' +
Â  Â  Â  Â  Â  Â  '<div style="font-size:48px;margin-bottom:16px;">ğŸ“¤</div>' +
Â  Â  Â  Â  Â  Â  '<div style="font-size:18px;font-weight:600;color:#333;margin-bottom:20px;">åœ–ç‰‡ä¸Šå‚³ä¸­...</div>' +
Â  Â  Â  Â  Â  Â  '<div style="background:#eee;border-radius:10px;height:20px;overflow:hidden;margin-bottom:12px;">' +
Â  Â  Â  Â  Â  Â  Â  '<div id="upload-progress-bar" style="background:linear-gradient(90deg,#f48fb1,#ec407a);height:100%;width:' + initialPercent + '%;transition:width 0.3s;border-radius:10px;"></div>' +
Â  Â  Â  Â  Â  Â  '</div>' +
Â  Â  Â  Â  Â  Â  '<div id="upload-progress-text" style="font-size:16px;font-weight:700;color:#ec407a;">' + initialPercent + '%</div>' +
Â  Â  Â  Â  Â  '</div>' +
Â  Â  Â  Â  '</div>';
Â  Â  Â  document.body.appendChild(overlay);
Â  Â  }
Â  Â Â 
Â  Â  function updateUploadProgress(percent) {
Â  Â  Â  const bar = document.getElementById('upload-progress-bar');
Â  Â  Â  const text = document.getElementById('upload-progress-text');
Â  Â  Â  if (bar) bar.style.width = percent + '%';
Â  Â  Â  if (text) text.textContent = percent + '%';
Â  Â  }
Â  Â Â 
Â  Â  function hideUploadingOverlay() {
Â  Â  Â  const overlay = document.getElementById('uploading-overlay');
Â  Â  Â  if (overlay) overlay.remove();
Â  Â  }
Â  Â  document.getElementById('file-input-camera').addEventListener('change', handleFileSelect);
Â  Â  document.getElementById('file-input-gallery').addEventListener('change', handleFileSelect);

Â  Â  // ====== Helper Functions ======
Â  Â  function showToast(message) {
Â  Â  Â  const container = document.getElementById('toast-container');
Â  Â  Â  container.innerHTML = '<div class="toast">' + message + '</div>';
Â  Â  Â  setTimeout(function() { container.innerHTML = ''; }, 2500);
Â  Â  }

Â  Â  // ====== Renders ======
Â  Â  function renderModal() {
Â  Â  Â  const container = document.getElementById('modal-container');
Â  Â  Â  if (state.showUploadModal) {
Â  Â  Â  Â  container.innerHTML =Â 
Â  Â  Â  Â  Â  '<div class="upload-modal" onclick="hideUploadModal()">' +
Â  Â  Â  Â  Â  Â  '<div class="upload-modal-content" onclick="event.stopPropagation()">' +
Â  Â  Â  Â  Â  Â  Â  '<div class="upload-modal-title">ğŸ“· é¸æ“‡åœ–ç‰‡ä¾†æº</div>' +
Â  Â  Â  Â  Â  Â  Â  '<div class="upload-option" onclick="triggerCameraUpload()">' +
Â  Â  Â  Â  Â  Â  Â  Â  '<span class="upload-option-icon">ğŸ“¸</span>' +
Â  Â  Â  Â  Â  Â  Â  Â  '<span class="upload-option-text">æ‹ç…§</span>' +
Â  Â  Â  Â  Â  Â  Â  '</div>' +
Â  Â  Â  Â  Â  Â  Â  '<div class="upload-option" onclick="triggerGalleryUpload()">' +
Â  Â  Â  Â  Â  Â  Â  Â  '<span class="upload-option-icon">ğŸ–¼ï¸</span>' +
Â  Â  Â  Â  Â  Â  Â  Â  '<span class="upload-option-text">å¾ç›¸ç°¿é¸æ“‡</span>' +
Â  Â  Â  Â  Â  Â  Â  '</div>' +
Â  Â  Â  Â  Â  Â  Â  '<button class="upload-modal-cancel" onclick="hideUploadModal()">å–æ¶ˆ</button>' +
Â  Â  Â  Â  Â  Â  '</div>' +
Â  Â  Â  Â  Â  '</div>';
Â  Â  Â  } else {
Â  Â  Â  Â  container.innerHTML = '';
Â  Â  Â  }
Â  Â  }

Â  Â  function render() {
Â  Â  Â  const app = document.getElementById('app');
Â  Â  Â  let content = '';
Â  Â  Â  if (state.view === 'login') content = renderLogin();
Â  Â  Â  else if (state.view === 'admin') content = renderAdmin();
Â  Â  Â  else if (state.view === 'customer') content = renderCustomer();
Â  Â  Â  else if (state.view === 'success') content = renderSuccess();
Â  Â  Â Â 
Â  Â  Â  const urlParams = new URLSearchParams(window.location.search);
Â  Â  Â  if (!urlParams.has('sheet') && state.isLoggedIn) {
Â  Â  Â  Â  content += renderBottomNav();
Â  Â  Â  }
Â  Â  Â Â 
Â  Â  Â  app.innerHTML = content;
Â  Â  }

Â  Â  function renderLogin() {
Â  Â  Â  return '<div class="container" style="display:flex;align-items:center;justify-content:center;min-height:80vh;">' +
Â  Â  Â  Â  Â  '<div class="card" style="width:100%;text-align:center;">' +
Â  Â  Â  Â  Â  Â  '<div style="font-size:60px;margin-bottom:20px;">ğŸ”’</div>' +
Â  Â  Â  Â  Â  Â  '<h1>ç®¡ç†å“¡ç™»å…¥</h1>' +
Â  Â  Â  Â  Â  Â  '<p class="subtitle">è«‹è¼¸å…¥å¯†ç¢¼ä»¥é€²å…¥å¾Œå°</p>' +
Â  Â  Â  Â  Â  Â  '<div class="form-group">' +
Â  Â  Â  Â  Â  Â  Â  '<input type="password" id="admin-password" placeholder="è«‹è¼¸å…¥å¯†ç¢¼" style="text-align:center;letter-spacing:4px;">' +
Â  Â  Â  Â  Â  Â  '</div>' +
Â  Â  Â  Â  Â  Â  '<button class="btn btn-primary" onclick="doLogin()">ç™»å…¥</button>' +
Â  Â  Â  Â  Â  '</div>' +
Â  Â  Â  Â  '</div>';
Â  Â  }

Â  Â  function renderAdmin() {
Â  Â  Â  if (state.adminMode === 'create' || !state.currentSheet) {
Â  Â  Â  Â  return renderCreateForm();
Â  Â  Â  } else {
Â  Â  Â  Â  return renderStats();
Â  Â  Â  }
Â  Â  }

Â  Â  function renderCreateForm() {
Â  Â  Â  // 1. æº–å‚™ä¸‹æ‹‰é¸å–®çš„é¸é …
Â  Â  Â  let sheetOptions = '<option value="">ğŸ“‚ åˆ‡æ›è‡³å·²å»ºç«‹çš„åœ˜è³¼...</option>';
Â  Â  Â  if (state.sheetList && state.sheetList.length > 0) {
Â  Â  Â  Â  state.sheetList.forEach(function(name) {
Â  Â  Â  Â  Â  sheetOptions += '<option value="' + name + '">' + name + '</option>';
Â  Â  Â  Â  });
Â  Â  Â  } else {
Â  Â  Â  Â  sheetOptions += '<option disabled>è¼‰å…¥ä¸­æˆ–ç„¡è³‡æ–™...</option>';
Â  Â  Â  }

Â  Â  Â  let itemsHTML = '';
Â  Â  Â  for (let index = 0; index < state.items.length; index++) {
Â  Â  Â  Â  const item = state.items[index];
Â  Â  Â  Â  const isUploading = state.uploadingIndex === index;
Â  Â  Â  Â  itemsHTML +=Â 
Â  Â  Â  Â  '<div class="admin-item">' +
Â  Â  Â  Â  Â  '<div class="admin-item-row">' +
Â  Â  Â  Â  Â  Â  '<input type="text" placeholder="å“é …åç¨±" value="' + item.name + '" onchange="updateItem(' + index + ', \'name\', this.value)" style="flex:2">' +
Â  Â  Â  Â  Â  Â  '<div style="display:flex; flex:1; gap:4px; align-items:center;">' +
Â  Â  Â  Â  Â  Â  Â  '<input type="number" placeholder="æ­£å–" value="' + item.limit + '" onchange="updateItem(' + index + ', \'limit\', this.value)" style="text-align:center">' +
Â  Â  Â  Â  Â  Â  Â  '<span style="font-size:12px;color:#666">æ­£</span>' +
Â  Â  Â  Â  Â  Â  '</div>' +
Â  Â  Â  Â  Â  Â  '<div style="display:flex; flex:1; gap:4px; align-items:center;">' +
Â  Â  Â  Â  Â  Â  Â  '<input type="number" placeholder="å€™è£œ" value="' + item.waitlist + '" onchange="updateItem(' + index + ', \'waitlist\', this.value)" style="text-align:center; color:#f59e0b; border-color:#fcd34d;">' +
Â  Â  Â  Â  Â  Â  Â  '<span style="font-size:12px;color:#f59e0b">è£œ</span>' +
Â  Â  Â  Â  Â  Â  '</div>' +
Â  Â  Â  Â  Â  Â  (state.items.length > 1 ? '<button class="remove-btn" onclick="removeItem(' + index + ')">Ã—</button>' : '') +
Â  Â  Â  Â  Â  '</div>' +
Â  Â  Â  Â  Â  '<div class="admin-item-row">' +
Â  Â  Â  Â  Â  Â  '<div class="image-upload-area" style="flex:1">' +
Â  Â  Â  Â  Â  Â  Â  (item.image ?Â 
Â  Â  Â  Â  Â  Â  Â  Â  '<img src="' + item.image + '" class="image-preview" onclick="showUploadOptions(' + index + ')">' :
Â  Â  Â  Â  Â  Â  Â  Â  '<div class="image-preview-placeholder" onclick="showUploadOptions(' + index + ')">ğŸ“·</div>'
Â  Â  Â  Â  Â  Â  Â  ) +
Â  Â  Â  Â  Â  Â  Â  '<div class="image-input-wrapper">' +
Â  Â  Â  Â  Â  Â  Â  Â  '<input type="text" placeholder="æˆ–è²¼ä¸Šåœ–ç‰‡ç¶²å€" value="' + item.image + '" onchange="updateItem(' + index + ', \'image\', this.value)" style="flex:1">' +
Â  Â  Â  Â  Â  Â  Â  Â  '<button class="upload-btn ' + (isUploading ? 'uploading' : '') + '" onclick="showUploadOptions(' + index + ')" ' + (isUploading ? 'disabled' : '') + '>' +
Â  Â  Â  Â  Â  Â  Â  Â  Â  (isUploading ? 'ä¸Šå‚³ä¸­...' : 'ä¸Šå‚³') +
Â  Â  Â  Â  Â  Â  Â  Â  '</button>' +
Â  Â  Â  Â  Â  Â  Â  '</div>' +
Â  Â  Â  Â  Â  Â  '</div>' +
Â  Â  Â  Â  Â  '</div>' +
Â  Â  Â  Â  Â  '<div class="admin-item-row">' +
Â  Â  Â  Â  Â  Â  '<textarea placeholder="å•†å“ç°¡ä»‹ï¼ˆé¸å¡«ï¼‰" onchange="updateItem(' + index + ', \'description\', this.value)">' + item.description + '</textarea>' +
Â  Â  Â  Â  Â  '</div>' +
Â  Â  Â  Â  '</div>';
Â  Â  Â  }

Â  Â  Â  return '<div class="container">' +
Â  Â  Â  Â  Â  '<div class="card">' +
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // â˜… æ–°å¢ï¼šé ‚éƒ¨åˆ‡æ›é¸å–®å€å¡Š â˜…
Â  Â  Â  Â  Â  Â  '<div style="margin-bottom:20px; padding-bottom:15px; border-bottom:1px dashed #ddd;">' +
Â  Â  Â  Â  Â  Â  Â  '<label style="color:#666;font-size:13px;margin-bottom:6px;">ğŸ“‚ ç®¡ç†ç¾æœ‰åœ˜è³¼</label>' +
Â  Â  Â  Â  Â  Â  Â  '<select onchange="switchAdminSheet(this.value)" style="width:100%; font-weight:bold; font-size:16px; padding:12px; border:2px solid #ddd; border-radius:12px; background:#f9f9f9;">' +
Â  Â  Â  Â  Â  Â  Â  Â  Â sheetOptions +
Â  Â  Â  Â  Â  Â  Â  '</select>' +
Â  Â  Â  Â  Â  Â  '</div>' +
Â  Â  Â  Â  Â  Â  // â˜… End â˜…

Â  Â  Â  Â  Â  Â  '<h1>ğŸ›’ å»ºç«‹æ–°åœ˜è³¼</h1>' +
Â  Â  Â  Â  Â  Â  '<p class="subtitle">è¨­å®šå“é …ï¼Œä¸€éµç”¢ç”Ÿè¡¨å–®</p>' +
Â  Â  Â  Â  Â  Â  '<div class="form-group">' +
Â  Â  Â  Â  Â  Â  Â  '<label>åœ˜è³¼æ¨™é¡Œ</label>' +
Â  Â  Â  Â  Â  Â  Â  '<input type="text" placeholder="ä¾‹å¦‚ï¼š2/4 è‰è“è›‹ç³•åœ˜" value="' + state.formTitle + '" onchange="state.formTitle=this.value">' +
Â  Â  Â  Â  Â  Â  '</div>' +
Â  Â  Â  Â  Â  Â  '<div class="form-group">' +
Â  Â  Â  Â  Â  Â  Â  '<label>å“é …è¨­å®š</label>' +
Â  Â  Â  Â  Â  Â  Â  itemsHTML +
Â  Â  Â  Â  Â  Â  '</div>' +
Â  Â  Â  Â  Â  Â  '<button class="btn btn-outline" onclick="addItem()">+ æ–°å¢å“é …</button>' +
Â  Â  Â  Â  Â  Â  (state.error ? '<div class="error-msg">' + state.error + '</div>' : '') +
Â  Â  Â  Â  Â  Â  '<button class="btn btn-primary" onclick="createForm()" ' + (state.loading ? 'disabled' : '') + '>' +
Â  Â  Â  Â  Â  Â  Â  (state.loading ? 'è™•ç†ä¸­...' : 'ğŸš€ ç”¢ç”Ÿè¡¨å–®') +
Â  Â  Â  Â  Â  Â  '</button>' +
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // ç™»å‡ºæŒ‰éˆ•ä¹Ÿè£œä¸€å€‹åœ¨é€™è£¡
Â  Â  Â  Â  Â  Â  '<div style="margin-top:20px; text-align:center;">' +
Â  Â  Â  Â  Â  Â  Â  Â '<button class="btn btn-outline" style="border-color:#ccc; color:#666; width:auto; display:inline-block; padding:10px 30px;" onclick="logout()">ğŸ”’ ç™»å‡ºå¾Œå°</button>' +
Â  Â  Â  Â  Â  Â  '</div>' +

Â  Â  Â  Â  Â  '</div>' +
Â  Â  Â  Â  '</div>';
Â  Â  }

Â  Â  function renderStats() {
Â  Â  Â  if (state.loading) return '<div class="container"><div class="loading"><div class="spinner"></div><div>è¼‰å…¥ä¸­...</div></div></div>';
Â  Â  Â Â 
Â  Â  Â  if (!state.formConfig) {
Â  Â  Â  Â  return '<div class="container">' +
Â  Â  Â  Â  Â  Â  '<div class="empty-state">' +
Â  Â  Â  Â  Â  Â  Â  '<div class="empty-icon">ğŸ“‹</div>' +
Â  Â  Â  Â  Â  Â  Â  '<div>æ‰¾ä¸åˆ°è¡¨å–®è³‡æ–™</div>' +
Â  Â  Â  Â  Â  Â  Â  '<div style="font-size:14px; color:#999; margin-bottom:20px;">å¯èƒ½è©²é–‹åœ˜åˆ†é å·²è¢«åˆªé™¤</div>' +
Â  Â  Â  Â  Â  Â  Â  '<button class="btn btn-primary" style="width: auto; padding: 10px 24px;" onclick="newForm()">' +
Â  Â  Â  Â  Â  Â  Â  Â  '+ é–‹æ–°åœ˜' +
Â  Â  Â  Â  Â  Â  Â  '</button>' +
Â  Â  Â  Â  Â  Â  '</div>' +
Â  Â  Â  Â  Â  '</div>';
Â  Â  Â  }

Â  Â  Â  const currentStatus = state.formConfig.status || 'OPEN';
Â  Â  Â  const isClosed = currentStatus === 'CLOSED';

Â  Â  Â  const ordersByStore = {};
Â  Â  Â  const ordersByItem = {};
Â  Â  Â  state.orders.forEach(function(order) {
Â  Â  Â  Â  if (!ordersByStore[order.store]) ordersByStore[order.store] = [];
Â  Â  Â  Â  ordersByStore[order.store].push(order);
Â  Â  Â  Â  const cleanName = order.item.replace(' (å€™è£œ)', '');
Â  Â  Â  Â  if (!ordersByItem[order.item]) ordersByItem[order.item] = 0;
Â  Â  Â  Â  ordersByItem[order.item] += order.quantity;
Â  Â  Â  });
Â  Â  Â  const uniquePhones = new Set(state.orders.map(function(o) { return o.phone; }));
Â  Â  Â Â 
Â  Â  Â  const displayTitle = state.formConfig.title.replace(/\s*\(\d+\)$/, '');
Â  Â  Â Â 
Â  Â  Â  let itemStatsHTML = '';
Â  Â  Â  state.formConfig.items.forEach(function(item) {
Â  Â  Â  Â  const ordered = ordersByItem[item.name] || 0;
Â  Â  Â  Â  const limit = parseInt(item.limit);
Â  Â  Â  Â  const waitlist = parseInt(item.waitlist || 0);
Â  Â  Â  Â  const totalLimit = limit + waitlist;

Â  Â  Â  Â  let statusText = '';
Â  Â  Â  Â  let barColorClass = 'normal';
Â  Â  Â  Â Â 
Â  Â  Â  Â  if (ordered < limit) {
Â  Â  Â  Â  Â  statusText = ordered + ' / ' + limit + ' (æ­£å–)';
Â  Â  Â  Â  } else if (ordered < totalLimit) {
Â  Â  Â  Â  Â  statusText = ordered + ' / ' + totalLimit + ' (é€²å…¥å€™è£œ ' + (ordered - limit) + '/' + waitlist + ')';
Â  Â  Â  Â  Â  barColorClass = 'waitlist';
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  statusText = 'å·²é¡æ»¿ (' + ordered + '/' + totalLimit + ')';
Â  Â  Â  Â  Â  barColorClass = 'full';
Â  Â  Â  Â  }

Â  Â  Â  Â  const percentage = Math.min((ordered / totalLimit) * 100, 100);

Â  Â  Â  Â  itemStatsHTML +=Â 
Â  Â  Â  Â  Â  '<div style="margin-bottom:16px; border-bottom:1px dashed #eee; padding-bottom:12px;">' +
Â  Â  Â  Â  Â  Â  '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">' +
Â  Â  Â  Â  Â  Â  Â  '<span style="font-weight:500;color:#333">' + item.name + '</span>' +
Â  Â  Â  Â  Â  Â  Â  '<button onclick="editItemLimit(\'' + item.name + '\', ' + limit + ', ' + waitlist + ')" style="padding:4px 8px; font-size:12px; border:1px solid #ddd; background:#fff; border-radius:6px; cursor:pointer;">âœï¸ ä¿®æ”¹</button>' +
Â  Â  Â  Â  Â  Â  '</div>' +
Â  Â  Â  Â  Â  Â  '<div style="display:flex;justify-content:space-between;font-size:13px;margin-bottom:4px;">' +
Â  Â  Â  Â  Â  Â  Â  '<span style="color:#666">é€²åº¦ï¼š</span>' +
Â  Â  Â  Â  Â  Â  Â  '<span style="font-weight:bold; color:' + (barColorClass === 'full' ? '#ef4444' : (barColorClass === 'waitlist' ? '#f59e0b' : '#10b981')) + '">' + statusText + '</span>' +
Â  Â  Â  Â  Â  Â  '</div>' +
Â  Â  Â  Â  Â  Â  '<div class="progress-bar">' +
Â  Â  Â  Â  Â  Â  Â  '<div class="progress-fill ' + barColorClass + '" style="width:' + percentage + '%"></div>' +
Â  Â  Â  Â  Â  Â  '</div>' +
Â  Â  Â  Â  Â  '</div>';
Â  Â  Â  });

Â  Â  Â  let storeOrdersHTML = '';
Â  Â  Â  Object.keys(ordersByStore).forEach(function(store) {
Â  Â  Â  Â  const orders = ordersByStore[store];
Â  Â  Â  Â  const ordersByPhone = {};
Â  Â  Â  Â  orders.forEach(function(order) {
Â  Â  Â  Â  Â  if (!ordersByPhone[order.phone]) ordersByPhone[order.phone] = { phone: order.phone, items: {} };
Â  Â  Â  Â  Â  if (!ordersByPhone[order.phone].items[order.item]) ordersByPhone[order.phone].items[order.item] = 0;
Â  Â  Â  Â  Â  ordersByPhone[order.phone].items[order.item] += order.quantity;
Â  Â  Â  Â  });
Â  Â  Â  Â  let orderRows = '';
Â  Â  Â  Â  Object.values(ordersByPhone).forEach(function(o) {
Â  Â  Â  Â  Â  const itemsArr = [];
Â  Â  Â  Â  Â  Object.keys(o.items).forEach(function(name) {
Â  Â  Â  Â  Â  Â  itemsArr.push(name + 'Ã—' + o.items[name]);
Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  const itemsText = itemsArr.join(', ');
Â  Â  Â  Â  Â  orderRows += '<div class="order-row"><span class="order-phone">...' + o.phone + '</span><span class="order-items">' + itemsText + '</span></div>';
Â  Â  Â  Â  });
Â  Â  Â  Â  storeOrdersHTML +=Â 
Â  Â  Â  Â  Â  '<div class="order-group">' +
Â  Â  Â  Â  Â  Â  '<div class="order-group-header">' +
Â  Â  Â  Â  Â  Â  Â  '<span class="order-group-title">ğŸ“ ' + store + '</span>' +
Â  Â  Â  Â  Â  Â  Â  '<span class="order-group-badge">' + Object.keys(ordersByPhone).length + ' äºº</span>' +
Â  Â  Â  Â  Â  Â  '</div>' +
Â  Â  Â  Â  Â  Â  orderRows +
Â  Â  Â  Â  Â  '</div>';
Â  Â  Â  });

Â  Â  Â  const customerLink = window.location.href.split('?')[0] + '?sheet=' + encodeURIComponent(state.currentSheet);
Â  Â  Â  const displayLink = state.shortUrl || customerLink;
Â  Â  Â  const isShortUrl = !!state.shortUrl;

Â  Â  Â  // è£½ä½œä¸‹æ‹‰é¸å–®çš„ HTML
Â  Â  Â  let sheetOptions = '';
Â  Â  Â  if (state.sheetList && state.sheetList.length > 0) {
Â  Â  Â  Â  state.sheetList.forEach(function(name) {
Â  Â  Â  Â  Â  sheetOptions += '<option value="' + name + '"' + (state.currentSheet === name ? ' selected' : '') + '>' + name + '</option>';
Â  Â  Â  Â  });
Â  Â  Â  } else {
Â  Â  Â  Â  sheetOptions = '<option>' + state.currentSheet + '</option>';
Â  Â  Â  }

Â  Â  Â  return '<div class="container">' +
Â  Â  Â  Â  Â  '<div class="card">' +
Â  Â  Â  Â  Â  Â  '<div style="margin-bottom:20px">' +
Â  Â  Â  Â  Â  Â  Â  '<label style="color:#666;font-size:12px;margin-bottom:4px;">ğŸ“‚ åˆ‡æ›åœ˜è³¼æ´»å‹•</label>' +
Â  Â  Â  Â  Â  Â  Â  '<div style="display:flex; gap:10px;">' +
Â  Â  Â  Â  Â  Â  Â  Â  '<select onchange="switchAdminSheet(this.value)" style="flex:1; font-weight:bold; font-size:18px; padding:10px;">' +
Â  Â  Â  Â  Â  Â  Â  Â  Â  sheetOptions +
Â  Â  Â  Â  Â  Â  Â  Â  '</select>' +
Â  Â  Â  Â  Â  Â  Â  Â  '<button class="btn btn-primary" style="width:auto;padding:10px 16px;font-size:14px;margin:0;white-space:nowrap;" onclick="newForm()">+ é–‹æ–°åœ˜</button>' +
Â  Â  Â  Â  Â  Â  Â  '</div>' +
Â  Â  Â  Â  Â  Â  Â  '<div style="display:flex;justify-content:flex-end;margin-top:10px;">' +
Â  Â  Â  Â  Â  Â  Â  Â  '<button class="btn" style="width:auto;padding:6px 12px;font-size:14px;margin:0;background:' + (isClosed ? '#10b981' : '#ef4444') + ';color:#fff" onclick="toggleFormStatus(\'' + (isClosed ? 'OPEN' : 'CLOSED') + '\')">' +Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  (isClosed ? 'ğŸŸ¢ é–‹å•Ÿæ¥å–®' : 'ğŸ”´ åœæ­¢æ¥å–®') +Â 
Â  Â  Â  Â  Â  Â  Â  Â  '</button>' +
Â  Â  Â  Â  Â  Â  Â  '</div>' +
Â  Â  Â  Â  Â  Â  '</div>' +

Â  Â  Â  Â  Â  Â  (isClosed ? '<div style="background:#fee2e2;color:#b91c1c;padding:10px;border-radius:8px;text-align:center;margin-bottom:16px;font-weight:bold;">â›” æ­¤è¡¨å–®ç›®å‰å·²åœæ­¢æ¥å–®</div>' : '') +

Â  Â  Â  Â  Â  Â  '<div style="margin-bottom:24px">' +
Â  Â  Â  Â  Â  Â  Â  '<label style="margin-bottom:12px;color:#666">å“é …çµ±è¨ˆ (é»æ“Šâœï¸å¯ä¿®æ”¹æ•¸é‡)</label>' +
Â  Â  Â  Â  Â  Â  Â  itemStatsHTML +
Â  Â  Â  Â  Â  Â  '</div>' +
Â  Â  Â  Â  Â  Â  '<div class="stat-card">' +
Â  Â  Â  Â  Â  Â  Â  '<div class="stat-label">è¨‚è³¼äººæ•¸</div>' +
Â  Â  Â  Â  Â  Â  Â  '<div class="stat-value">' + uniquePhones.size + '</div>' +
Â  Â  Â  Â  Â  Â  '</div>' +
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  '<div class="link-box">' +
Â  Â  Â  Â  Â  Â  Â  '<div class="link-label">ğŸ“ å®¢äººå¡«å¯«é€£çµï¼ˆåˆ†äº«åˆ° LINE ç¤¾ç¾¤ï¼‰' +Â 
Â  Â  Â  Â  Â  Â  Â  Â  (isShortUrl ? ' <span style="background:#10b981;color:#fff;padding:2px 8px;border-radius:10px;font-size:12px;margin-left:6px;">å·²è½‰ç‚ºçŸ­ç¶²å€</span>' : '') +Â 
Â  Â  Â  Â  Â  Â  Â  '</div>' +
Â  Â  Â  Â  Â  Â  Â  '<div class="link-row">' +
Â  Â  Â  Â  Â  Â  Â  Â  '<input type="text" class="link-input" value="' + displayLink + '" readonly id="customerLink">' +
Â  Â  Â  Â  Â  Â  Â  Â  '<button class="copy-btn" onclick="copyLink()">è¤‡è£½é€£çµ</button>' +
Â  Â  Â  Â  Â  Â  Â  '</div>' +
Â  Â  Â  Â  Â  Â  Â  (!isShortUrl ?Â 
Â  Â  Â  Â  Â  Â  Â  Â  '<button class="btn-generate-short" onclick="generateShortUrl()">' +
Â  Â  Â  Â  Â  Â  Â  Â  Â  'ğŸš€ é»æ­¤ç”¢ç”ŸçŸ­ç¶²å€çµ¦å®¢äººå¡«å¯« (æ¨è–¦)' +Â 
Â  Â  Â  Â  Â  Â  Â  Â  '</button>' : ''
Â  Â  Â  Â  Â  Â  Â  ) +
Â  Â  Â  Â  Â  Â  '</div>' +

Â  Â  Â  Â  Â  Â  '<div class="card" style="margin-top: 20px;">' +
Â  Â  Â  Â  Â  Â  Â  '<h2 style="font-size:16px; margin-bottom:12px;">ğŸ“Š å¾Œå°å ±è¡¨ä½œæ¥­</h2>' +
Â  Â  Â  Â  Â  Â  Â  '<button class="btn btn-outline" onclick="triggerPivotTable()">' +
Â  Â  Â  Â  Â  Â  Â  Â  'âš¡ æ›´æ–°åˆ†åº—çµ±è¨ˆè¡¨ (å¯«å…¥ Google Sheet)' +
Â  Â  Â  Â  Â  Â  Â  '</button>' +
Â  Â  Â  Â  Â  Â  '</div>' +

Â  Â  Â  Â  Â  '</div>' +
Â  Â  Â  Â  Â  (storeOrdersHTML ? '<div class="card"><h2 style="font-size:18px;margin-bottom:16px;color:#333;font-weight:700">ğŸ“‹ è¨‚å–®æ˜ç´°</h2>' + storeOrdersHTML + '</div>' : '<div class="empty-state"><div class="empty-icon">ğŸ“­</div><div>é‚„æ²’æœ‰è¨‚å–®</div></div>') +
Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  '<div style="margin-top:20px; text-align:center;">' +
Â  Â  Â  Â  Â  Â  Â '<button class="btn btn-outline" style="border-color:#ccc; color:#666; width:auto; display:inline-block; padding:10px 30px;" onclick="logout()">ğŸ”’ ç™»å‡ºå¾Œå°</button>' +
Â  Â  Â  Â  Â  '</div>' +

Â  Â  Â  Â  '</div>';
Â  Â  }
Â  Â Â 
Â  Â  function renderCustomer() {
Â  Â  Â  if (!state.currentSheet) return '<div class="container"><div class="empty-state"><div class="empty-icon">ğŸ“‹</div><div>å°šæœªé–‹åœ˜</div><div style="margin-top:8px;font-size:14px">è«‹ç­‰å¾…åœ˜ä¸»åˆ†äº«é€£çµ</div></div></div>';
Â  Â  Â  if (state.loading) return '<div class="container"><div class="loading"><div class="spinner"></div><div>è¼‰å…¥ä¸­...</div></div></div>';
Â  Â  Â  if (!state.formConfig) return '<div class="container"><div class="empty-state"><div class="empty-icon">âŒ</div><div>æ‰¾ä¸åˆ°æ­¤åœ˜è³¼è¡¨å–®</div></div></div>';

Â  Â  Â  if (state.formConfig.status === 'CLOSED') {
Â  Â  Â  Â  return '<div class="container">' +
Â  Â  Â  Â  Â  '<div class="card" style="text-align:center;padding:40px 20px;">' +
Â  Â  Â  Â  Â  Â  '<div style="font-size:48px;margin-bottom:20px;">â›”</div>' +
Â  Â  Â  Â  Â  Â  '<h2 style="margin-bottom:10px;color:#333;">è¡¨å–®å·²æˆªæ­¢</h2>' +
Â  Â  Â  Â  Â  Â  '<p style="color:#666;">è¬è¬æ‚¨çš„æ”¯æŒï¼Œæœ¬æ¬¡åœ˜è³¼å·²åœæ­¢æ¥å–®ã€‚</p>' +
Â  Â  Â  Â  Â  '</div>' +
Â  Â  Â  Â  '</div>';
Â  Â  Â  }

Â  Â  Â  let storeOptions = '';
Â  Â  Â  STORES.forEach(function(s) {
Â  Â  Â  Â  storeOptions += '<option value="' + s + '"' + (state.selectedStore === s ? ' selected' : '') + '>' + s + '</option>';
Â  Â  Â  });

Â  Â  Â  let itemsHTML = '';
Â  Â  Â  state.formConfig.items.forEach(function(item) {
Â  Â  Â  Â  const limit = parseInt(item.limit);
Â  Â  Â  Â  const waitlist = parseInt(item.waitlist || 0);
Â  Â  Â  Â  const ordered = item.ordered || 0;

Â  Â  Â  Â  const regularRemaining = Math.max(0, limit - ordered);
Â  Â  Â  Â  const waitlistUsed = Math.max(0, ordered - limit);
Â  Â  Â  Â  const waitlistRemaining = Math.max(0, waitlist - waitlistUsed);

Â  Â  Â  Â  const isFullySoldOut = (regularRemaining === 0 && waitlistRemaining === 0);
Â  Â  Â  Â  const selectedQty = state.selectedItems[item.name] || 0;
Â  Â  Â  Â Â 
Â  Â  Â  Â  let statusBadge = '';
Â  Â  Â  Â  let cardStyle = '';
Â  Â  Â  Â  let btnStyle = '';

Â  Â  Â  Â  if (isFullySoldOut) {
Â  Â  Â  Â  Â  statusBadge = '<div class="item-stock sold-out">âŒ å·²é¡æ»¿ (å”®å®Œ)</div>';
Â  Â  Â  Â  Â  cardStyle = 'border-color:#ffcccc; background:#fff0f0;';
Â  Â  Â  Â  } else if (regularRemaining > 0) {
Â  Â  Â  Â  Â  statusBadge = `
Â  Â  Â  Â  Â  Â  <div class="item-stock available">
Â  Â  Â  Â  Â  Â  Â  ğŸ”¥ æ­£å–å‰© <span style="font-weight:800;font-size:15px;">${regularRemaining}</span> ä»½
Â  Â  Â  Â  Â  Â  Â  ${waitlist > 0 ? `<span style="color:#f59e0b; font-size:12px; margin-left:4px;">(å€™è£œå°šæœ‰ ${waitlistRemaining})</span>` : ''}
Â  Â  Â  Â  Â  Â  </div>`;
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  statusBadge = `
Â  Â  Â  Â  Â  Â  <div class="item-stock" style="color:#d97706; font-weight:bold;">
Â  Â  Â  Â  Â  Â  Â  âš ï¸ æ­£å–å·²æ»¿ï¼Œå€™è£œå‰© ${waitlistRemaining} ä»½
Â  Â  Â  Â  Â  Â  </div>`;
Â  Â  Â  Â  Â  cardStyle = 'border-color:#fcd34d; background:#fffbeb;';Â 
Â  Â  Â  Â  Â  btnStyle = 'background:#f59e0b; border-color:#f59e0b;';
Â  Â  Â  Â  }

Â  Â  Â  Â  const totalRemaining = regularRemaining + waitlistRemaining;

Â  Â  Â  Â  itemsHTML +=Â 
Â  Â  Â  Â  Â  '<div class="item-card" style="' + cardStyle + '">' +
Â  Â  Â  Â  Â  Â  '<div class="item-header">' +
Â  Â  Â  Â  Â  Â  Â  (item.image ? '<img src="' + item.image + '" class="item-image" onerror="this.style.display=\'none\'">' : '<div class="item-image-placeholder">ğŸ›ï¸</div>') +
Â  Â  Â  Â  Â  Â  Â  '<div class="item-info">' +
Â  Â  Â  Â  Â  Â  Â  Â  '<div class="item-name">' + item.name + '</div>' +
Â  Â  Â  Â  Â  Â  Â  Â  (item.description ? '<div class="item-desc">' + item.description + '</div>' : '') +
Â  Â  Â  Â  Â  Â  Â  Â  statusBadge +
Â  Â  Â  Â  Â  Â  Â  '</div>' +
Â  Â  Â  Â  Â  Â  '</div>' +
Â  Â  Â  Â  Â  Â  (!isFullySoldOut ?Â 
Â  Â  Â  Â  Â  Â  Â  '<div class="item-controls">' +
Â  Â  Â  Â  Â  Â  Â  Â  '<button class="qty-btn" onclick="changeQty(\'' + item.name + '\', -1)" ' + (selectedQty <= 0 ? 'disabled' : '') + '>âˆ’</button>' +
Â  Â  Â  Â  Â  Â  Â  Â  '<span class="qty-display">' + selectedQty + '</span>' +
Â  Â  Â  Â  Â  Â  Â  Â  '<button class="qty-btn plus" onclick="changeQty(\'' + item.name + '\', 1)" ' + (selectedQty >= totalRemaining ? 'disabled' : '') + ' style="' + btnStyle + '">+</button>' +
Â  Â  Â  Â  Â  Â  Â  '</div>' : '') +
Â  Â  Â  Â  Â  '</div>';
Â  Â  Â  });

Â  Â  Â  const displayTitle = state.formConfig.title.replace(/\s*\(\d+\)$/, '');

Â  Â  Â  return '<div class="container">' +
Â  Â  Â  Â  Â  '<div class="brand-header">' +
Â  Â  Â  Â  Â  Â  '<div class="brand-logo">' +
Â  Â  Â  Â  Â  Â  Â  '<img src="https://i.ibb.co/RTfWybqw/image.png" alt="Logo">' +
Â  Â  Â  Â  Â  Â  '</div>' +
Â  Â  Â  Â  Â  Â  '<div class="brand-name">åŒ…å­åª½ç”Ÿé®®å°èˆ–</div>' +
Â  Â  Â  Â  Â  Â  '<div class="group-title">' + displayTitle + '</div>' +
Â  Â  Â  Â  Â  '</div>' +
Â  Â  Â  Â  Â  '<div class="card">' +
Â  Â  Â  Â  Â  Â  '<p class="subtitle">è«‹å¡«å¯«ä»¥ä¸‹è³‡æ–™å®Œæˆç™»è¨˜</p>' +
Â  Â  Â  Â  Â  Â  '<div class="form-group">' +
Â  Â  Â  Â  Â  Â  Â  '<label>ğŸ“ å–è²¨åˆ†åº—</label>' +
Â  Â  Â  Â  Â  Â  Â  '<select onchange="state.selectedStore=this.value;state.error=\'\';render()">' +
Â  Â  Â  Â  Â  Â  Â  Â  '<option value="">è«‹é¸æ“‡åˆ†åº—</option>' +
Â  Â  Â  Â  Â  Â  Â  Â  storeOptions +
Â  Â  Â  Â  Â  Â  Â  '</select>' +
Â  Â  Â  Â  Â  Â  '</div>' +
Â  Â  Â  Â  Â  Â  '<div class="form-group">' +
Â  Â  Â  Â  Â  Â  Â  '<label>ğŸ“± é›»è©±å¾Œå…­ç¢¼</label>' +
Â  Â  Â  Â  Â  Â  Â  '<input type="tel" placeholder="ä¾‹å¦‚ï¼š123456" maxlength="6" value="' + state.phone + '" oninput="state.phone=this.value.slice(0,6);state.error=\'\'" style="letter-spacing:4px;text-align:center">' +
Â  Â  Â  Â  Â  Â  '</div>' +
Â  Â  Â  Â  Â  Â  '<div class="form-group">' +
Â  Â  Â  Â  Â  Â  Â  '<label>ğŸ›’ é¸æ“‡å“é …</label>' +
Â  Â  Â  Â  Â  Â  Â  itemsHTML +
Â  Â  Â  Â  Â  Â  '</div>' +
Â  Â  Â  Â  Â  Â  (state.error ? '<div class="error-msg">' + state.error + '</div>' : '') +
Â  Â  Â  Â  Â  Â  '<button class="btn btn-primary" onclick="submitOrder()" ' + (state.loading ? 'disabled' : '') + '>' +
Â  Â  Â  Â  Â  Â  Â  (state.loading ? 'é€å‡ºä¸­...' : 'âœ“ ç¢ºèªç™»è¨˜') +
Â  Â  Â  Â  Â  Â  '</button>' +
Â  Â  Â  Â  Â  '</div>' +
Â  Â  Â  Â  '</div>';
Â  Â  }

Â  Â  function renderSuccess() {
Â  Â  Â  const info = state.successInfo || {};
Â  Â  Â  let itemsHTML = '';
Â  Â  Â  if (info.items) {
Â  Â  Â  Â  Object.keys(info.items).forEach(function(name) {
Â  Â  Â  Â  Â  const qty = info.items[name];
Â  Â  Â  Â  Â  if (qty > 0) {
Â  Â  Â  Â  Â  Â  itemsHTML += '<div class="success-item">' + name + ' Ã— ' + qty + '</div>';
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });
Â  Â  Â  }
Â  Â  Â  return '<div class="container">' +
Â  Â  Â  Â  Â  '<div class="success-screen">' +
Â  Â  Â  Â  Â  Â  '<div class="success-content">' +
Â  Â  Â  Â  Â  Â  Â  '<div class="success-icon-container">' +
Â  Â  Â  Â  Â  Â  Â  Â  '<svg class="success-svg" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">' +
Â  Â  Â  Â  Â  Â  Â  Â  Â  '<path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>' +
Â  Â  Â  Â  Â  Â  Â  Â  '</svg>' +
Â  Â  Â  Â  Â  Â  Â  '</div>' +
Â  Â  Â  Â  Â  Â  Â  '<h2 class="success-title">ç™»è¨˜æˆåŠŸï¼</h2>' +
Â  Â  Â  Â  Â  Â  Â  '<div class="success-info">å–è²¨åˆ†åº—ï¼š' + info.store + '<br>é›»è©±æœ«å…­ç¢¼ï¼š' + info.phone + '</div>' +
Â  Â  Â  Â  Â  Â  Â  '<div class="success-items">' + itemsHTML + '</div>' +
Â  Â  Â  Â  Â  Â  Â  '<button class="btn btn-primary" style="margin-top:24px;" onclick="resetCustomerForm()">ç¹¼çºŒç™»è¨˜å…¶ä»–å“é …</button>' +
Â  Â  Â  Â  Â  Â  '</div>' +
Â  Â  Â  Â  Â  '</div>' +
Â  Â  Â  Â  '</div>';
Â  Â  }

Â  Â  function renderBottomNav() {
Â  Â  Â  return '<div class="bottom-nav">' +
Â  Â  Â  Â  Â  '<button class="nav-btn ' + (state.view === 'admin' ? 'active' : '') + '" onclick="switchView(\'admin\')">ğŸ‘¤ ç®¡ç†</button>' +
Â  Â  Â  Â  Â  '<button class="nav-btn ' + (state.view === 'customer' || state.view === 'success' ? 'active' : '') + '" onclick="switchView(\'customer\')">ğŸ›’ å®¢äºº</button>' +
Â  Â  Â  Â  '</div>';
Â  Â  }

Â  Â  // ====== Actions ======
Â  Â  function switchView(view) {
Â  Â  Â  state.view = view;
Â  Â  Â  state.error = '';
Â  Â  Â  if (view === 'customer' && state.currentSheet) loadFormData();
Â  Â  Â  else if (view === 'admin' && state.currentSheet && state.adminMode === 'stats') loadOrders();
Â  Â  Â  render();
Â  Â  }

Â  Â  function addItem() {
Â  Â  Â  state.items.push({ name: '', limit: 30, waitlist: 0, image: '', description: '' });
Â  Â  Â  render();
Â  Â  }

Â  Â  function removeItem(index) {
Â  Â  Â  if (state.items.length > 1) {
Â  Â  Â  Â  state.items.splice(index, 1);
Â  Â  Â  Â  render();
Â  Â  Â  }
Â  Â  }

Â  Â  function updateItem(index, field, value) {
Â  Â  Â  state.items[index][field] = (field === 'limit' || field === 'waitlist') ? (parseInt(value) || 0) : value;
Â  Â  Â  if (field === 'image') render();
Â  Â  }

Â  Â  async function createForm() {
Â  Â  Â  const validItems = state.items.filter(function(item) { return item.name.trim(); });
Â  Â  Â  if (validItems.length === 0) {
Â  Â  Â  Â  state.error = 'è«‹è‡³å°‘å¡«å¯«ä¸€å€‹å“é …åç¨±';
Â  Â  Â  Â  render();
Â  Â  Â  Â  return;
Â  Â  Â  }
Â  Â  Â  state.loading = true;
Â  Â  Â  state.error = '';
Â  Â  Â  render();
Â  Â  Â  const formTitle = state.formTitle || new Date().toLocaleDateString('zh-TW') + ' é–‹åœ˜';
Â  Â  Â  try {
Â  Â  Â  Â  const response = await fetch(SCRIPT_URL, {
Â  Â  Â  Â  Â  method: 'POST',
Â  Â  Â  Â  Â  body: JSON.stringify({ action: 'createForm', formTitle: formTitle, items: validItems, stores: STORES })
Â  Â  Â  Â  });
Â  Â  Â  Â  const result = await response.json();
Â  Â  Â  Â  if (result.success) {
Â  Â  Â  Â  Â  state.currentSheet = result.sheetName;
Â  Â  Â  Â  Â  state.formConfig = result.formConfig;
Â  Â  Â  Â  Â  state.adminMode = 'stats';
Â  Â  Â  Â  Â  state.orders = [];
Â  Â  Â  Â  Â  localStorage.setItem('currentSheet', state.currentSheet);
Â  Â  Â  Â  Â  showToast('âœ… é–‹åœ˜æˆåŠŸï¼');
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  state.error = result.error || 'å»ºç«‹å¤±æ•—ï¼Œè«‹é‡è©¦';
Â  Â  Â  Â  }
Â  Â  Â  } catch (error) {
Â  Â  Â  Â  state.currentSheet = formTitle;
Â  Â  Â  Â  state.formConfig = { title: formTitle, items: validItems.map(function(item) { return Object.assign({}, item, { ordered: 0, remaining: item.limit }); }), stores: STORES };
Â  Â  Â  Â  state.adminMode = 'stats';
Â  Â  Â  Â  state.orders = [];
Â  Â  Â  Â  localStorage.setItem('currentSheet', state.currentSheet);
Â  Â  Â  Â  showToast('âœ… é–‹åœ˜æˆåŠŸï¼');
Â  Â  Â  }
Â  Â  Â  state.loading = false;
Â  Â  Â  render();
Â  Â  }

Â  Â  function newForm() {
Â  Â  Â  state.adminMode = 'create';
Â  Â  Â  state.formTitle = '';
Â  Â  Â  state.items = [{ name: '', limit: 30, waitlist: 0, image: '', description: '' }];
Â  Â  Â  state.error = '';
Â  Â  Â  state.shortUrl = '';
Â  Â  Â  localStorage.removeItem('shortUrl');
Â  Â  Â  render();
Â  Â  }

Â  Â  async function loadOrders() {
Â  Â  Â  state.loading = true;
Â  Â  Â  render();
Â  Â  Â  try {
Â  Â  Â  Â  const response = await fetch(SCRIPT_URL + '?action=getOrders&sheetName=' + encodeURIComponent(state.currentSheet));
Â  Â  Â  Â  const result = await response.json();
Â  Â  Â  Â  if (result.success) {
Â  Â  Â  Â  Â  state.orders = result.orders || [];
Â  Â  Â  Â  Â  state.formConfig = result.formConfig;
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  state.formConfig = null;
Â  Â  Â  Â  }
Â  Â  Â  } catch (error) {
Â  Â  Â  Â  console.error('Load orders error:', error);
Â  Â  Â  Â  state.formConfig = null;
Â  Â  Â  }
Â  Â  Â  state.loading = false;
Â  Â  Â  render();
Â  Â  }

Â  Â  function copyLink() {
Â  Â  Â  const input = document.getElementById('customerLink');
Â  Â  Â  input.select();
Â  Â  Â  input.setSelectionRange(0, 99999);
Â  Â  Â  document.execCommand('copy');
Â  Â  Â  showToast('âœ… é€£çµå·²è¤‡è£½ï¼');
Â  Â  }

Â  Â  async function generateShortUrl() {
Â  Â  Â  const longUrl = window.location.href.split('?')[0] + '?sheet=' + encodeURIComponent(state.currentSheet);
Â  Â  Â  showToast('ğŸ”— æ­£åœ¨ç”¢è£½å°ˆå±¬çŸ­é€£çµ...');
Â  Â  Â  try {
Â  Â  Â  Â  const response = await fetch(SCRIPT_URL, {
Â  Â  Â  Â  Â  method: 'POST',
Â  Â  Â  Â  Â  body: JSON.stringify({ action: 'generateShortUrl', longUrl: longUrl })
Â  Â  Â  Â  });
Â  Â  Â  Â  const result = await response.json();
Â  Â  Â  Â  if (result.success && result.shortURL) {
Â  Â  Â  Â  Â  state.shortUrl = result.shortURL;
Â  Â  Â  Â  Â  localStorage.setItem('shortUrl', state.shortUrl);
Â  Â  Â  Â  Â  showToast('âœ… å°ˆå±¬çŸ­ç¶²å€å·²ç”¢ç”Ÿï¼');
Â  Â  Â  Â  Â  render();
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  throw new Error(result.error || 'å¾Œå°ç”¢è£½å¤±æ•—');
Â  Â  Â  Â  }
Â  Â  Â  } catch (error) {
Â  Â  Â  Â  console.error('Short.io error:', error);
Â  Â  Â  Â  showToast('âŒ ç”¢ç”Ÿå¤±æ•—ï¼š' + error.message);
Â  Â  Â  }
Â  Â  }
Â  Â Â 
Â  Â  // æ‰‹å‹•è§¸ç™¼çµ±è¨ˆè¡¨
Â  Â  async function triggerPivotTable() {
Â  Â  Â  if (!confirm('ç¢ºå®šè¦é‡æ–°è¨ˆç®—ä¸¦è¦†è“‹ Google Sheet ä¸Šçš„çµ±è¨ˆè¡¨å—ï¼Ÿ')) return;
Â  Â  Â  showToast('â³ æ­£åœ¨è¨ˆç®—çµ±è¨ˆå ±è¡¨...');
Â  Â  Â  try {
Â  Â  Â  Â  const response = await fetch(SCRIPT_URL, {
Â  Â  Â  Â  Â  method: 'POST',
Â  Â  Â  Â  Â  body: JSON.stringify({ action: 'generatePivot', sheetName: state.currentSheet })
Â  Â  Â  Â  });
Â  Â  Â  Â  const result = await response.json();
Â  Â  Â  Â  if (result.success) {
Â  Â  Â  Â  Â  showToast('âœ… ' + result.message);
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  showToast('âŒ å¤±æ•—ï¼š' + result.error);
Â  Â  Â  Â  }
Â  Â  Â  } catch (error) {
Â  Â  Â  Â  showToast('âŒ é€£ç·šéŒ¯èª¤');
Â  Â  Â  Â  console.error(error);
Â  Â  Â  }
Â  Â  }

Â  Â  // ç‹€æ…‹é–‹é—œ
Â  Â  async function toggleFormStatus(newStatus) {
Â  Â  Â  if (!confirm('ç¢ºå®šè¦' + (newStatus === 'CLOSED' ? 'åœæ­¢' : 'é–‹å•Ÿ') + 'æ¥å–®å—ï¼Ÿ')) return;
Â  Â  Â  state.loading = true;
Â  Â  Â  render();
Â  Â  Â  try {
Â  Â  Â  Â  const response = await fetch(SCRIPT_URL, {
Â  Â  Â  Â  Â  method: 'POST',
Â  Â  Â  Â  Â  body: JSON.stringify({ action: 'updateSettings', sheetName: state.currentSheet, newStatus: newStatus })
Â  Â  Â  Â  });
Â  Â  Â  Â  const result = await response.json();
Â  Â  Â  Â  if (result.success) {
Â  Â  Â  Â  Â  state.formConfig = result.formConfig;
Â  Â  Â  Â  Â  showToast('âœ… ç‹€æ…‹å·²æ›´æ–°');
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  showToast('âŒ æ›´æ–°å¤±æ•—ï¼š' + result.error);
Â  Â  Â  Â  }
Â  Â  Â  } catch (error) {
Â  Â  Â  Â  showToast('âŒ é€£ç·šéŒ¯èª¤');
Â  Â  Â  }
Â  Â  Â  state.loading = false;
Â  Â  Â  render();
Â  Â  }

Â  Â  // ä¿®æ”¹æ•¸é‡
Â  Â  async function editItemLimit(itemName, currentLimit, currentWaitlist) {
Â  Â  Â  const newLimit = prompt('ä¿®æ”¹ [' + itemName + '] çš„ "æ­£å–" æ•¸é‡ï¼š', currentLimit);
Â  Â  Â  if (newLimit === null) return;
Â  Â  Â  const newWaitlist = prompt('ä¿®æ”¹ [' + itemName + '] çš„ "å€™è£œ" æ•¸é‡ï¼š', currentWaitlist);
Â  Â  Â  if (newWaitlist === null) return;

Â  Â  Â  state.loading = true;
Â  Â  Â  render();
Â  Â  Â  try {
Â  Â  Â  Â  const response = await fetch(SCRIPT_URL, {
Â  Â  Â  Â  Â  method: 'POST',
Â  Â  Â  Â  Â  body: JSON.stringify({Â 
Â  Â  Â  Â  Â  Â  action: 'updateSettings',Â 
Â  Â  Â  Â  Â  Â  sheetName: state.currentSheet,Â 
Â  Â  Â  Â  Â  Â  updateItem: { name: itemName, limit: newLimit, waitlist: newWaitlist }
Â  Â  Â  Â  Â  })
Â  Â  Â  Â  });
Â  Â  Â  Â  const result = await response.json();
Â  Â  Â  Â  if (result.success) {
Â  Â  Â  Â  Â  state.formConfig = result.formConfig;
Â  Â  Â  Â  Â  showToast('âœ… æ•¸é‡å·²æ›´æ–°');
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  showToast('âŒ æ›´æ–°å¤±æ•—ï¼š' + result.error);
Â  Â  Â  Â  }
Â  Â  Â  } catch (error) {
Â  Â  Â  Â  showToast('âŒ é€£ç·šéŒ¯èª¤');
Â  Â  Â  }
Â  Â  Â  state.loading = false;
Â  Â  Â  render();
Â  Â  }

Â  Â  // â˜… å–å¾—æ‰€æœ‰åˆ†é æ¸…å–®
Â  Â  async function loadSheetList() {
Â  try {
Â  Â  const response = await fetch(SCRIPT_URL + '?action=getSheetList');
Â  Â  const result = await response.json();
Â  Â  if (result.success) {
Â  Â  Â  state.sheetList = result.sheetNames;
Â  Â  } else {
Â  Â  Â  console.error('è¼‰å…¥åˆ†é æ¸…å–®å¤±æ•—:', result.error);
Â  Â  Â  state.sheetList = [];
Â  Â  }
Â  } catch (error) {
Â  Â  console.error('ç„¡æ³•å–å¾—åˆ†é æ¸…å–®', error);
Â  Â  state.sheetList = [];
Â  }
Â  // âœ… ç„¡è«–æˆåŠŸæˆ–å¤±æ•—éƒ½è¦æ¸²æŸ“
Â  render();
}

Â  Â  async function loadFormData() {
Â  Â  Â  state.loading = true;
Â  Â  Â  render();
Â  Â  Â  try {
Â  Â  Â  Â  const response = await fetch(SCRIPT_URL + '?action=getFormData&sheetName=' + encodeURIComponent(state.currentSheet));
Â  Â  Â  Â  const result = await response.json();
Â  Â  Â  Â  if (result.success) state.formConfig = result.formConfig;
Â  Â  Â  Â  else state.formConfig = null;
Â  Â  Â  } catch (error) {
Â  Â  Â  Â  console.error('Load form error:', error);
Â  Â  Â  }
Â  Â  Â  state.loading = false;
Â  Â  Â  render();
Â  Â  }

Â  Â  function changeQty(itemName, delta) {
Â  Â  Â  const currentQty = state.selectedItems[itemName] || 0;
Â  Â  Â  const newQty = Math.max(0, currentQty + delta);
Â  Â  Â  const item = state.formConfig.items.find(function(i) { return i.name === itemName; });
Â  Â  Â  if (item) {
Â  Â  Â  Â  const remaining = item.remaining !== undefined ? item.remaining : (item.limit - (item.ordered || 0));
Â  Â  Â  Â  if (newQty <= remaining) state.selectedItems[itemName] = newQty;
Â  Â  Â  }
Â  Â  Â  render();
Â  Â  }

Â  Â  async function submitOrder() {
Â  Â  Â  if (!state.selectedStore) {
Â  Â  Â  Â  state.error = 'è«‹é¸æ“‡å–è²¨åˆ†åº—';
Â  Â  Â  Â  render();
Â  Â  Â  Â  return;
Â  Â  Â  }
Â  Â  Â  if (!state.phone || state.phone.length !== 6 || !/^\d+$/.test(state.phone)) {
Â  Â  Â  Â  state.error = 'è«‹è¼¸å…¥æ­£ç¢ºçš„é›»è©±å¾Œå…­ç¢¼';
Â  Â  Â  Â  render();
Â  Â  Â  Â  return;
Â  Â  Â  }
Â  Â  Â  const orderItems = {};
Â  Â  Â  let hasItem = false;
Â  Â  Â  Object.keys(state.selectedItems).forEach(function(name) {
Â  Â  Â  Â  const qty = state.selectedItems[name];
Â  Â  Â  Â  if (qty > 0) {
Â  Â  Â  Â  Â  orderItems[name] = qty;
Â  Â  Â  Â  Â  hasItem = true;
Â  Â  Â  Â  }
Â  Â  Â  });
Â  Â  Â  if (!hasItem) {
Â  Â  Â  Â  state.error = 'è«‹è‡³å°‘é¸æ“‡ä¸€å€‹å“é …';
Â  Â  Â  Â  render();
Â  Â  Â  Â  return;
Â  Â  Â  }
Â  Â  Â  state.loading = true;
Â  Â  Â  state.error = '';
Â  Â  Â  render();
Â  Â  Â  try {
Â  Â  Â  Â  const response = await fetch(SCRIPT_URL, {
Â  Â  Â  Â  Â  method: 'POST',
Â  Â  Â  Â  Â  body: JSON.stringify({ action: 'submitOrder', sheetName: state.currentSheet, store: state.selectedStore, phone: state.phone, items: orderItems })
Â  Â  Â  Â  });
Â  Â  Â  Â  const result = await response.json();
Â  Â  Â  Â  if (result.success) {
Â  Â  Â  Â  Â  state.successInfo = { store: state.selectedStore, phone: state.phone, items: orderItems };
Â  Â  Â  Â  Â  state.view = 'success';
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  state.error = result.error || 'é€å‡ºå¤±æ•—ï¼Œè«‹é‡è©¦';
Â  Â  Â  Â  }
Â  Â  Â  } catch (error) {
Â  Â  Â  Â  state.successInfo = { store: state.selectedStore, phone: state.phone, items: orderItems };
Â  Â  Â  Â  state.view = 'success';
Â  Â  Â  }
Â  Â  Â  state.loading = false;
Â  Â  Â  render();
Â  Â  }

Â  Â  function resetCustomerForm() {
Â  Â  Â  state.view = 'customer';
Â  Â  Â  state.selectedStore = '';
Â  Â  Â  state.phone = '';
Â  Â  Â  state.selectedItems = {};
Â  Â  Â  state.error = '';
Â  Â  Â  loadFormData();
Â  Â  }

Â  Â  async function init() {
Â  Â  Â  console.log('âœ… init() é–‹å§‹åŸ·è¡Œ');
Â  const urlParams = new URLSearchParams(window.location.search);
Â  const sheetParam = urlParams.get('sheet');
Â Â 
Â  if (sheetParam) {
Â  Â  // === å®¢äººæ¨¡å¼ ===
Â  Â  state.currentSheet = sheetParam;
Â  Â  state.view = 'customer';
Â  Â  localStorage.setItem('currentSheet', sheetParam);
Â  Â  render();Â  // âœ… å…ˆé¡¯ç¤ºè¼‰å…¥ä¸­
Â  Â  loadFormData();
Â  } else {
Â  Â  // === ç®¡ç†å“¡æ¨¡å¼ ===
Â  Â  const storedLogin = localStorage.getItem('isAdminLoggedIn');
Â  Â Â 
Â  Â  if (storedLogin === 'true') {
Â  Â  Â  state.isLoggedIn = true;
Â  Â  Â  state.view = 'admin';Â 
Â  Â  Â  state.adminMode = 'stats';
Â  Â  Â Â 
Â  Â  Â  // âœ… å…ˆæ¸²æŸ“ç•«é¢
Â  Â  Â  render();
Â  Â  Â Â 
Â  Â  Â  // âœ… ç„¶å¾ŒèƒŒæ™¯è¼‰å…¥è³‡æ–™
Â  Â  Â  await loadSheetList();
Â  Â  Â  if (state.currentSheet) {
Â  Â  Â  Â  await loadOrders();
Â  Â  Â  }
Â  Â  } else {
Â  Â  Â  state.view = 'login';
Â  Â  Â  render();Â  // âœ… é¡¯ç¤ºç™»å…¥é 
Â  Â  }
Â  }
}

Â  Â  async function doLogin() {
      const pwd = document.getElementById('admin-password').value;
      if (!pwd) return;
       
      state.loading = true;
      const btn = document.querySelector('.btn-primary');
      if(btn) btn.innerText = 'é©—è­‰ä¸­...';

      try {
        const response = await fetch(SCRIPT_URL, {
          method: 'POST',
          body: JSON.stringify({ action: 'login', password: pwd })
        });
        const result = await response.json();
        
        if (result.success) {
          state.isLoggedIn = true;
          state.view = 'admin';
          localStorage.setItem('isAdminLoggedIn', 'true');
          
          // âœ… å…ˆæ¸²æŸ“ä¸€æ¬¡ï¼ˆé¡¯ç¤ºè¼‰å…¥ä¸­ï¼‰
          render();
          
          // âœ… ç„¶å¾ŒéåŒæ­¥è¼‰å…¥è³‡æ–™
          await loadSheetList();
          if (state.currentSheet) {
            await loadOrders();
          }
          
        } else {
          showToast('âŒ å¯†ç¢¼éŒ¯èª¤');
          if(btn) btn.innerText = 'ç™»å…¥';
        }
      } catch (e) {
        showToast('âŒ é€£ç·šéŒ¯èª¤');
        if(btn) btn.innerText = 'ç™»å…¥';
        console.error(e);
      }
      state.loading = false;
    }

Â  Â  // ç™»å‡ºåŠŸèƒ½
Â  Â  function logout() {
Â  Â  Â  localStorage.removeItem('isAdminLoggedIn');
Â  Â  Â  state.isLoggedIn = false;
Â  Â  Â  state.view = 'login';
Â  Â  Â  state.currentSheet = '';
Â  Â  Â  state.orders = [];
Â  Â  Â  state.formConfig = null;
Â  Â  Â Â 
Â  Â  Â  render();
Â  Â  Â  showToast('ğŸ”’ å·²å®‰å…¨ç™»å‡º');
Â  Â  }

Â  Â  function switchAdminSheet(sheetName) {
Â  Â  Â  state.currentSheet = sheetName;
Â  Â  Â  localStorage.setItem('currentSheet', sheetName);
Â  Â  Â  state.shortUrl = '';Â 
Â  Â  Â  localStorage.removeItem('shortUrl');
Â  Â  Â  loadOrders();Â 
Â  Â  }

Â  Â  init();
Â  </script>
</body>
</html>
